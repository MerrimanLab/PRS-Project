# Running all models of interest

The purpose of this section is to run all models of interest for assessing the relationship between gout genetic risk and severity of gout. This includes modeling gout vs the PRS, and modeling age at onset, tophi, and flare frequency vs the PRS. For now, I have decided to not run flare frequency models and to just display the plots while discussing how complex the flare phenotype is.

```{r dataprep3}
# Datasets
load(here("Output/all_pheno_prs.RData"))

# Making FLARE_CAT variable and setting all control gout severity traits to NA
all_pheno_prs <- all_pheno_prs %>%
  mutate(FLARE_CAT = factor(case_when(between(NUMATK, 0, 5) ~ paste0(as.character(NUMATK), " flares in last year"),
                                      between(NUMATK, 6, 11) ~ "One every one to two months", 
                                      between(NUMATK, 12, 52) ~ "One or more per month"),
                            levels = c(paste0(0:5, " flares in last year"),
                                       "One every one to two months",
                                       "One or more per month"),
                            labels = c(paste0(0:5), 
                                       "6 - 11",
                                       "12 - 52"),
                            ordered = TRUE),
         AGE1ATK = case_when(GOUT ~ AGE1ATK),
         DURATION = case_when(GOUT ~ DURATION),
         NUMATK = case_when(GOUT ~ NUMATK),
         TOPHIGOUT = case_when(GOUT ~ TOPHIGOUT),
         ULT = case_when(GOUT ~ ULT),
         SEX = factor(SEX, levels = c("Male", "Female")),
         GOUT2 = factor(GOUT, levels = c(TRUE, FALSE), labels = c("Gout", "Control")),
         GROUP = factor(case_when(GOUT & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "European Gout",
                                  !GOUT & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "European Control",
                                  GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study != "Ngati Porou" ~ "East Polynesian Gout",
                                  !GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study != "Ngati Porou" ~ "East Polynesian Control",
                                  GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study == "Ngati Porou" ~ "East Polynesian Gout - NP",
                                  !GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study == "Ngati Porou" ~ "East Polynesian Control - NP",
                                  GOUT & Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan") ~ "West Polynesian Gout",
                                  !GOUT & Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan") ~ "West Polynesian Control"), 
                        levels = c("European Gout", "European Control", "East Polynesian Gout", "East Polynesian Control", "East Polynesian Gout - NP", "East Polynesian Control - NP", "West Polynesian Gout", "West Polynesian Control")),
         GROUP2 = factor(case_when(GROUP == "European Gout" & SEX == "Male" ~ "European Gout - male",
                                  GROUP == "European Gout" & SEX == "Female" ~ "European Gout - female",
                                  GROUP == "European Control" & SEX == "Male" ~ "European Control - male",
                                  GROUP == "European Control" & SEX == "Female" ~ "European Control - female",
                                  GROUP == "East Polynesian Gout" & SEX == "Male" ~ "East Polynesian Gout - male",
                                  GROUP == "East Polynesian Gout" & SEX == "Female" ~ "East Polynesian Gout - female",
                                  GROUP == "East Polynesian Control" & SEX == "Male" ~ "East Polynesian Control - male",
                                  GROUP == "East Polynesian Control" & SEX == "Female" ~ "East Polynesian Control - female",
                                  GROUP == "East Polynesian Gout - NP" & SEX == "Male" ~ "East Polynesian Gout - NP - male",
                                  GROUP == "East Polynesian Gout - NP" & SEX == "Female" ~ "East Polynesian Gout - NP - female",
                                  GROUP == "East Polynesian Control - NP" & SEX == "Male" ~ "East Polynesian Control - NP - male",
                                  GROUP == "East Polynesian Control - NP" & SEX == "Female" ~ "East Polynesian Control - NP - female",
                                  GROUP == "West Polynesian Gout" & SEX == "Male" ~ "West Polynesian Gout - male",
                                  GROUP == "West Polynesian Gout" & SEX == "Female" ~ "West Polynesian Gout - female",
                                  GROUP == "West Polynesian Control" & SEX == "Male" ~ "West Polynesian Control - male",
                                  GROUP == "West Polynesian Control" & SEX == "Female" ~ "West Polynesian Control - female"), 
                        levels = c("European Gout - male", "European Gout - female", "European Control - male", "European Control - female", "East Polynesian Gout - male", "East Polynesian Gout - female", "East Polynesian Control - male", "East Polynesian Control - female", "East Polynesian Gout - NP - male", "East Polynesian Gout - NP - female", "East Polynesian Control - NP - male", "East Polynesian Control - NP - female", "West Polynesian Gout - male", "West Polynesian Gout - female", "West Polynesian Control - male", "West Polynesian Control - female")),
         GROUP3 = factor(case_when(GOUT & SEX == "Male" ~ "Male Gout",
                                   GOUT & SEX == "Female" ~ "Female Gout",
                                   !GOUT & SEX == "Male" ~ "Male Control",
                                   !GOUT & SEX == "Female" ~ "Female Control"), 
                         levels = c("Male Gout", "Female Gout", "Male Control", "Female Control")),
         COHORT2 = factor(case_when(GOUT & Pheno.Study == "UK Biobank" ~ "UK Biobank - Gout",
                                    !GOUT & Pheno.Study == "UK Biobank" ~ "UK Biobank - Control",
                                    GOUT & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") & Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease") ~ "Aus/NZ - Gout",
                                    !GOUT & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") & Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease") ~ "Aus/NZ - Control",
                                    GOUT & Pheno.Study == "EuroGout" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "GlobalGout - Gout",
                                    !GOUT & Pheno.Study == "EuroGout" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "GlobalGout - Control",
                                    Pheno.Study == "Ardea: 401" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "Ardea - LASSO",
                                    Pheno.Study == "Ardea: CLEAR1" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "Ardea - CLEAR1",
                                    Pheno.Study == "Ardea: CLEAR2" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "Ardea - CLEAR2",
                                    Pheno.Study == "Ardea: CRYSTAL" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "Ardea - CRYSTAL",
                                    Pheno.Study == "Ardea: LIGHT" & Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian") ~ "Ardea - LIGHT",
                                    GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study != "Ngati Porou" ~ "East Polynesian - Gout",
                                    !GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study != "Ngati Porou" ~ "East Polynesian - Control",
                                    GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study == "Ngati Porou" ~ "East Polynesian - Gout - NP",
                                    !GOUT & Geno.SpecificAncestry %in% c("East Polynesian") & Pheno.Study == "Ngati Porou" ~ "East Polynesian - Control - NP",
                                    GOUT & Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan") ~ "West Polynesian - Gout",
                                    !GOUT & Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan") ~ "West Polynesian - Control"), 
                          levels = c("UK Biobank - Gout", "UK Biobank - Control", "Aus/NZ - Gout", "Aus/NZ - Control", "GlobalGout - Gout", "GlobalGout - Control", "Ardea - LASSO", "Ardea - CLEAR1", "Ardea - CLEAR2", "Ardea - CRYSTAL", "Ardea - LIGHT", "East Polynesian - Gout", "East Polynesian - Control", "East Polynesian - Gout - NP", "East Polynesian - Control - NP", "West Polynesian - Gout", "West Polynesian - Control")),
         NUMATK = round(NUMATK)) %>% 
  filter(!is.na(AGECOL),
         !is.na(PRS),
         (Pheno.Study == "UK Biobank" | !GOUT | GOUT & !(is.na(AGE1ATK) & is.na(NUMATK) & is.na(TOPHIGOUT))),
         !is.na(COHORT2))

all_pheno_prs_male <- all_pheno_prs %>% 
  filter(SEX == "Male")

all_pheno_prs_female <- all_pheno_prs %>% 
  filter(SEX == "Female")

data_list <- list("UK Biobank - Gout - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                             Pheno.Study == "UK Biobank"),
                  "UK Biobank - Gout - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                 Pheno.Study == "UK Biobank"),
                  "UK Biobank - Control - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                Pheno.Study == "UK Biobank"),
                  "UK Biobank - Control - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                    Pheno.Study == "UK Biobank"),
                  "Aus/NZ European - Gout - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                                  Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian"),
                                                                                  Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease")),
                  "Aus/NZ European - Gout - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                      Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian"),
                                                                                      Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease")),
                  "Aus/NZ European - Control - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                     Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian"),
                                                                                     Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease")),
                  "Aus/NZ European - Control - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                         Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian"),
                                                                                         Pheno.Study %in% c("AGRIA", "Diabetes Mellitus", "Gout in Aotearoa", "LPA", "Ngati Porou", "Renal Disease")),
                  "GlobalGout - Gout - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                             Pheno.Study == "EuroGout",
                                                                             Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "GlobalGout - Gout - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                 Pheno.Study == "EuroGout",
                                                                                 Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "GlobalGout - Control - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                Pheno.Study == "EuroGout",
                                                                                Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "GlobalGout - Control - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                    Pheno.Study == "EuroGout",
                                                                                    Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - LASSO - Male" = all_pheno_prs_male %>% filter(Pheno.Study == "Ardea: 401",
                                                                         Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - LASSO - Female" = all_pheno_prs_female %>% filter(Pheno.Study == "Ardea: 401",
                                                                             Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CLEAR1 - Male" = all_pheno_prs_male %>% filter(Pheno.Study == "Ardea: CLEAR1",
                                                                          Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CLEAR1 - Female" = all_pheno_prs_female %>% filter(Pheno.Study == "Ardea: CLEAR1",
                                                                              Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CLEAR2 - Male" = all_pheno_prs_male %>% filter(Pheno.Study == "Ardea: CLEAR2",
                                                                          Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CLEAR2 - Female" = all_pheno_prs_female %>% filter(Pheno.Study == "Ardea: CLEAR2",
                                                                              Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CRYSTAL - Male" = all_pheno_prs_male %>% filter(Pheno.Study == "Ardea: CRYSTAL",
                                                                           Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - CRYSTAL - Female" = all_pheno_prs_female %>% filter(Pheno.Study == "Ardea: CRYSTAL",
                                                                               Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - LIGHT - Male" = all_pheno_prs_male %>% filter(Pheno.Study == "Ardea: LIGHT",
                                                                         Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "Ardea - LIGHT - Female" = all_pheno_prs_female %>% filter(Pheno.Study == "Ardea: LIGHT",
                                                                             Geno.SpecificAncestry %in% c("European", "European; Iberian", "Iberian")),
                  "East Polynesian - Gout - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                                  Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study != "Ngati Porou"),
                  "East Polynesian - Gout - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                      Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study != "Ngati Porou"),
                  "East Polynesian - Control - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                     Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study != "Ngati Porou"),
                  "East Polynesian - Control - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                         Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study != "Ngati Porou"),
                  "East Polynesian - Gout - NP - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                                  Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study == "Ngati Porou"),
                  "East Polynesian - Gout - NP - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                      Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study == "Ngati Porou"),
                  "East Polynesian - Control - NP - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                     Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study == "Ngati Porou"),
                  "East Polynesian - Control - NP - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                         Geno.SpecificAncestry %in% c("East Polynesian"),
                                                                                  Pheno.Study == "Ngati Porou"),
                  "West Polynesian - Gout - Male" = all_pheno_prs_male %>% filter(GOUT,
                                                                                  Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan")),
                  "West Polynesian - Gout - Female" = all_pheno_prs_female %>% filter(GOUT,
                                                                                      Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan")),
                  "West Polynesian - Control - Male" = all_pheno_prs_male %>% filter(!GOUT,
                                                                                     Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan")),
                  "West Polynesian - Control - Female" = all_pheno_prs_female %>% filter(!GOUT,
                                                                                         Geno.SpecificAncestry %in% c("West Polynesian", "Niuean", "Pukapukan")))

load(here("Output/UKBB_Gene_OR.RData"))
```

```{r functions}
OR <- function(x, Predictor) {
  sprintf(exp(coef(x))[[Predictor]], fmt = "%#.4f")
}

LCL_OR <- function(x, Predictor) {
  sprintf(exp(confint.default(x))[Predictor, 1], fmt = "%#.4f")
}

UCL_OR <- function(x, Predictor) {
  sprintf(exp(confint.default(x))[Predictor, 2], fmt = "%#.4f")
}

Pval <- function(x, Predictor) {
  signif(summary(x)$coefficients[Predictor, 4], 3)
}

Beta <- function(x, Predictor) {
  sprintf(coef(x)[[Predictor]], fmt = "%#.4f")
}

LCL <- function(x, Predictor) {
  sprintf(confint.default(x)[Predictor, 1], fmt = "%#.4f")
}

UCL <- function(x, Predictor) {
  sprintf(confint.default(x)[Predictor, 2], fmt = "%#.4f")
}
```

First, I want to test the assumptions of the models of interest. For linear regression, the assumptions are:

1. Linear relationship between variables
2. Normality of residuals
3. Homoscedasticity of residuals
4. No multicollinearity (for multiple regression)

Logistic regression only relies on no multicollinearity. 

All assumptions should be tested for all models, but I will just test some representative models instead - the main thing is that extremely non-normal variables should not be used for linear regression. This should be tested for the age at onset variable, and the number of flares per year variable.

```{r Assumptions, eval = F}
# Age at onset -------------------------------------------------------------------------------------
# Representative linear model of age at onset vs the PRS in the combined male gout cohort
tmp <- all_pheno_prs %>% 
  filter(SEX == "Male",
         GOUT,
         Geno.SpecificAncestry %in% c("European", "Iberian", "European; Iberian"))

ggplot(tmp, aes(x = PRS, y = AGE1ATK, color = COHORT2)) +
  geom_point(shape = 1) +
  geom_smooth(se = FALSE) # No evidence of non-linearity

mod <- lm(AGE1ATK ~ PRS + Geno.PCVector1 + Geno.PCVector2 + Geno.PCVector3 + Geno.PCVector4 + Geno.PCVector5 + Geno.PCVector6 + Geno.PCVector7 + Geno.PCVector8 + Geno.PCVector9 + Geno.PCVector10, data = tmp)

test <- augment(mod)

ggplot(test, aes(x = .fitted, y = .resid)) +
  geom_point() # no obvious pattern, so homoscedasticity seems to be met

ggplot(data = test, mapping = aes(x = .resid)) + 
  geom_histogram(mapping = aes(y = ..density..), bins = 30, fill = 'gray', color = 'black') +
  stat_function(fun = 'dnorm', 
                args = list(mean = mean(test$.resid), sd = sd(test$.resid)), 
                color = 'red')

ggplot(data = test, mapping = aes(sample = .resid)) +
  geom_qq() +
  geom_qq_line()

ggplot(data = test, mapping = aes(x = .resid)) +
  geom_boxplot() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

test %>% 
  pull(.resid) %>% 
  stat.desc(basic = FALSE, desc = FALSE, norm = TRUE) %>% 
  enframe() %>% 
  pivot_wider(names_from = name, values_from = value)

# Normality of residuals is completely met here (ignore 2SE and shapiro-wilk test as this is large data)

vif(mod) # no multicollinearity (no values over 5 or 10)

# So we should have no problem running models of the PRS vs age at onset (as long as we don't include variables that exhibit multicollinearity)



# Flares (linear) ----------------------------------------------------------------------------------------
# First let's run a representative linear model of NUMATK vs PRS in the combined male gout cohort
tmp <- tmp %>% 
  mutate(NUMATK = case_when(NUMATK > 52 ~ 52,
                            TRUE ~ NUMATK)) %>% 
  filter(NUMATK >= 2)

ggplot(tmp, aes(x = PRS, y = NUMATK, color = COHORT2)) +
  geom_point(shape = 1) +
  geom_smooth(se = FALSE)

mod <- lm(NUMATK ~ PRS + Geno.PCVector1 + Geno.PCVector2 + Geno.PCVector3 + Geno.PCVector4 + Geno.PCVector5 + Geno.PCVector6 + Geno.PCVector7 + Geno.PCVector8 + Geno.PCVector9 + Geno.PCVector10, data = tmp)

test <- augment(mod)

ggplot(test, aes(x = .fitted, y = .resid)) +
  geom_point() # weird pattern, so homoscedasticity seems to not be met

ggplot(data = test, mapping = aes(x = .resid)) + 
  geom_histogram(mapping = aes(y = ..density..), bins = 30, fill = 'gray', color = 'black') +
  stat_function(fun = 'dnorm', 
                args = list(mean = mean(test$.resid), sd = sd(test$.resid)), 
                color = 'red')

ggplot(data = test, mapping = aes(sample = .resid)) +
  geom_qq() +
  geom_qq_line()

ggplot(data = test, mapping = aes(x = .resid)) +
  geom_boxplot() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

test %>% 
  pull(.resid) %>% 
  stat.desc(basic = FALSE, desc = FALSE, norm = TRUE) %>% 
  enframe() %>% 
  pivot_wider(names_from = name, values_from = value)

# Normality of residuals is not met here (ignore 2SE and shapiro-wilk test as this is large data)

vif(mod) # no multicollinearity (no values over 5 or 10)

# So it is not appropriate to use the NUMATK variable in a linear regression model



# Flares (ordinal) -----------------------------------------------------------------

# I will go ahead and test whether categorizing the variable (FLARE_CAT) and running an independent ANOVA or ordinal logistic regression model will be appropriate - note I am not sure how easy it will be to adjust for covariates in an ANOVA (perhaps I could run an ANCOVA but it might not be doing what I think it's doing)

# The ordinal logistic regression test should tell us the odds of being in any combination of higher flare categories vs the remainder of the categories (i.e. highest flare group vs all others, or highest 5 flare groups vs lowest flare group)

# I'll try running an example from a paper to see if I can replicate their results in R

# dat <- tibble("Group" = rep(c("Activator", "Headgear"), each = 50),
#               "Happiness" = factor(c(rep("Unhappy", 30), rep("Somewhat happy", 14), rep("Very happy", 6), rep("Unhappy", 14), rep("Somewhat happy", 25), rep("Very happy", 11)), levels = c("Unhappy", "Somewhat happy", "Very happy"), ordered = T))
# 
# mod <- MASS::polr(Happiness ~ Group, data = dat, Hess = TRUE)
# 
# modsum <- tibble("Group of interest" = row.names(summary(mod)$coefficients)[1],
#                  "OR" = exp(summary(mod)$coefficients)[1],
#                  "Lower CI" = exp(confint.default(mod))[1],
#                  "Upper CI" = exp(confint.default(mod))[2],
#                  "P-value" = pnorm(abs(summary(mod)$coefficients[1, "t value"]), lower.tail = FALSE) * 2)

# To interpret the odds ratio, we can say that for the group of children that wore Headgear, the odds of being more happy (i.e. being in a happiness tier or higher compared to a lower tier) were 3.27 times those of the the children that used an Activator 

# The parallel to this in our example would be that for those individuals with 1 unit more PRS than another group, the odds of being in a higher flare category (i.e. >= 3 flares vs < 3 flares) were X times those of the other group (i.e. those with 1 unit PRS lower - the reference group). Let's test this using an example model

mod <- polr(FLARE_CAT ~ PRS, data = tmp, Hess = TRUE)

modsum <- tibble("Group of interest" = row.names(summary(mod)$coefficients)[1],
                 "OR" = exp(summary(mod)$coefficients)[1],
                 "Lower CI" = exp(confint.default(mod))[1],
                 "Upper CI" = exp(confint.default(mod))[2],
                 "P-value" = pnorm(abs(summary(mod)$coefficients[1, "t value"]), lower.tail = FALSE) * 2)

# This suggests that the model is significant for the full male gout cohort, with an OR of 1.14 [1.03, 1.26], p = 0.0112 per PRS unit

# Can try to visualize this by looking at proportions of FLARE_CAT within bins of PRS

tmp %>% 
  filter(!is.na(PRS)) %>% 
  mutate(PRS_bin = factor(ntile(PRS, 6), ordered = T),
         FLARE_CAT = factor(case_when(is.na(FLARE_CAT) ~ "No Data",
                                      TRUE ~ as.character(FLARE_CAT)), 
                            levels = rev(c(paste0(0:5), 
                                       "6 - 11",
                                       "12 - 52",
                                       "No Data")),
                            ordered = TRUE)) %>%
  group_by(PRS_bin, FLARE_CAT, SEX, GROUP) %>% 
  summarize(value = n()) %>% 
  ggplot(aes(fill = FLARE_CAT, y = value, x = PRS_bin)) +
  geom_bar(position = "fill", stat = "identity") +
  facet_wrap(~ SEX * GROUP) +
  scale_fill_discrete(type = c("#C0C0C0", "#FDE725FF", "#9FDA3AFF", "#4AC16DFF", "#1FA187FF", "#277F8EFF", "#365C8DFF", "#46337EFF", "#440154FF")) +
  theme(axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.title = element_blank())



# Flares (ANOVA) --------------------------------------------------------------------------------------

# The ANOVA test will essentially ask "does the mean PRS differ between flare categories"
# I should further note that I am unclear on how to meta-analyze ANOVA results - perhaps just running them within each cohort and determining how many show significant differences and, of those, which groups were different and in which direction? The other option is to pull cohorts but that runs into potentially weird issues of bias. So I think in the end I should run both models and see if I get a different answer, then decide how to present them in the paper.

# The assumptions of a one-way independent ANOVA are:

# 1. Independence of the datapoints (met)
# 2. Normality of model residuals within groups
# 3. Homogeneity of variance of model residuals within groups

mod <- tmp %>% 
  mutate(IID = factor(IID),
         FLARE_CAT = factor(FLARE_CAT)) %>% 
  ezANOVA(data = .,
               dv = PRS,
               between = FLARE_CAT,
               wid = IID,
               type = 3,
               return_aov = TRUE)

mod

tmp %>% 
  ggplot(aes(x = FLARE_CAT, y = PRS)) +
  geom_boxplot()

rm(tmp, mod, modsum, test)
```

Based on the above, it should be appropriate to run linear regression models on age at onset, but not flare frequency. For flare frequency, I could use ordinal logistic regression after categorizing flares into roughly even groups (this regression assumes that the effect between two levels of the variable are consistent across levels of the variable). I could also use ANOVA but this may prove difficult to adjust for covariates. For now I won't run any models for this variable.

<br/>

```{r GoutModels, eval = F}
# We need to model the PRS, the PRS without ABCG2, and both ABCG2 SNPs against gout, adjusting for global PCs. It needs to be in males and females separately, and needs to be both adjusted for age at collection and unadjusted. It also needs to run with the 10 oceanian PCs for Polynesian cohorts. We want the output of all of these models to be stored in a list object which we can then extract all of the important elements from in a table format.

gout_data_list <- list("UK Biobank - Male" = full_join(data_list[["UK Biobank - Gout - Male"]], 
                                                       data_list[["UK Biobank - Control - Male"]]),
                       "UK Biobank - Female" = full_join(data_list[["UK Biobank - Gout - Female"]], 
                                                         data_list[["UK Biobank - Control - Female"]]),
                       "Aus/NZ European - Male" = full_join(data_list[["Aus/NZ European - Gout - Male"]],
                                                            data_list[["Aus/NZ European - Control - Male"]]),
                       "Aus/NZ European - Female" = full_join(data_list[["Aus/NZ European - Gout - Female"]],
                                                              data_list[["Aus/NZ European - Control - Female"]]),
                       "East Polynesian - Male" = full_join(data_list[["East Polynesian - Gout - Male"]],
                                                            data_list[["East Polynesian - Control - Male"]]),
                       "East Polynesian - Female" = full_join(data_list[["East Polynesian - Gout - Female"]],
                                                              data_list[["East Polynesian - Control - Female"]]),
                       "East Polynesian - NP - Male" = full_join(data_list[["East Polynesian - Gout - NP - Male"]],
                                                            data_list[["East Polynesian - Control - NP - Male"]]),
                       "East Polynesian - NP - Female" = full_join(data_list[["East Polynesian - Gout - NP - Female"]],
                                                              data_list[["East Polynesian - Control - NP - Female"]]),
                       "West Polynesian - Male" = full_join(data_list[["West Polynesian - Gout - Male"]],
                                                            data_list[["West Polynesian - Control - Male"]]),
                       "West Polynesian - Female" = full_join(data_list[["West Polynesian - Gout - Female"]],
                                                              data_list[["West Polynesian - Control - Female"]]))

for(i in length(gout_data_list):1){
  if(nrow(gout_data_list[[i]]) < 20){
    gout_data_list[[i]] <- NULL
  }
}

# I want to model the following for every cohort: PRS, PRS less ABCG2, both ABCG2 variants simultaneously; all models should be run with and without AGECOL as a covariate


modlist <- vector("list", length(gout_data_list))
for(i in seq_along(gout_data_list)){
  prsnames <- list("PRS", "PRS_noABCG2", c("rs2231142", "rs10011796"))
  
  covariates <- c()
  
  if(!str_detect(names(gout_data_list)[i], "UK Biobank")){
    covariates <- c(covariates, "Geno.PCVector1", "Geno.PCVector2", "Geno.PCVector3", "Geno.PCVector4", "Geno.PCVector5", "Geno.PCVector6", "Geno.PCVector7", "Geno.PCVector8", "Geno.PCVector9", "Geno.PCVector10")
  }
  
  if(str_detect(names(gout_data_list)[i], "Polynesian")){
    covariates <- c(covariates, "Geno.PCVector1_Oc", "Geno.PCVector2_Oc", "Geno.PCVector3_Oc", "Geno.PCVector4_Oc", "Geno.PCVector5_Oc", "Geno.PCVector6_Oc", "Geno.PCVector7_Oc", "Geno.PCVector8_Oc", "Geno.PCVector9_Oc", "Geno.PCVector10_Oc")
  }
  
  covariates2 <- c(covariates, "AGECOL")
  
  tmplist <- vector("list", 2 * length(prsnames))
  
  for(j in seq_along(prsnames)) {
    variables <- c(prsnames[[j]], covariates)
    f <- as.formula(paste("GOUT", paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0("Model_", i, "_", j), glm(f, family = binomial, data = gout_data_list[[i]]))
    # columns will be: Cohort, N, N case, N control, Outcome, Predictors, Predictor, Covariates, OR, LCL, UCL, Pval, log-odds, standard error
    modstring1 <- c(names(gout_data_list)[[i]],
                    nrow(gout_data_list[[i]]),
                    nrow(gout_data_list[[i]] %>% filter(GOUT)),
                    nrow(gout_data_list[[i]] %>% filter(!GOUT)),
                    "Gout")
    
    modstring <- list()
    if(any(str_detect(prsnames[[j]], "PRS"))) {
      modstring[[1]] <- c(modstring1,
                          paste(prsnames[[j]], collapse = " + "),
                          paste(prsnames[[j]], collapse = " + "),
                          paste(covariates, collapse = " + "),
                          OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          LCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          UCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          coef(get(paste0("Model_", i, "_", j)))[[prsnames[[j]]]],
                          summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]], 2])
    } else{
      for(k in 1:length(prsnames[[j]])){
        modstring[[k]] <- c(modstring1,
                            paste(prsnames[[j]], collapse = " + "),
                            paste(prsnames[[j]][k], collapse = " + "),
                            paste(covariates, collapse = " + "),
                            OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            LCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            UCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            coef(get(paste0("Model_", i, "_", j)))[[prsnames[[j]][k]]],
                            summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]][k], 2])
      }
    }
    
    tmplist[[j]] <- modstring
    
    variables <- c(prsnames[[j]], covariates2)
    f <- as.formula(paste("GOUT", paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0("Model_", i, "_", j, "_adj"), glm(f, family = binomial, data = gout_data_list[[i]]))
    modstring1 <- c(names(gout_data_list)[[i]],
                    nrow(gout_data_list[[i]]),
                    nrow(gout_data_list[[i]] %>% filter(GOUT)),
                    nrow(gout_data_list[[i]] %>% filter(!GOUT)),
                    "Gout")
    
    modstring <- list()
    if(any(str_detect(prsnames[[j]], "PRS"))) {
      modstring[[1]] <- c(modstring1,
                          paste(prsnames[[j]], collapse = " + "),
                          paste(prsnames[[j]], collapse = " + "),
                          paste(covariates2, collapse = " + "),
                          OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          LCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          UCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          Pval(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          coef(get(paste0("Model_", i, "_", j, "_adj")))[[prsnames[[j]]]],
                          summary(get(paste0("Model_", i, "_", j, "_adj")))$coefficients[prsnames[[j]], 2])
    } else{
      for(k in 1:length(prsnames[[j]])){
        modstring[[k]] <- c(modstring1,
                            paste(prsnames[[j]], collapse = " + "),
                            paste(prsnames[[j]][k], collapse = " + "),
                            paste(covariates2, collapse = " + "),
                            OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            LCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            UCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            Pval(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            coef(get(paste0("Model_", i, "_", j, "_adj")))[[prsnames[[j]][k]]],
                            summary(get(paste0("Model_", i, "_", j, "_adj")))$coefficients[prsnames[[j]][k], 2])
      }
    }
    
    tmplist[[j + length(prsnames)]] <- modstring
  }
  
  modlist[[i]] <- tmplist
}

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "Model_"))
remove <- remove$value
rm(list = remove, remove)


tmp <- modlist %>% 
  flatten() %>% 
  flatten() %>% 
  as.data.frame() %>% 
  data.table::transpose()

colnames(tmp) <- c("Cohort", "N", "N case", "N control", "Outcome", "Predictors", "Predictor", "Covariates", "OR", "LCL", "UCL", "Pval", "log-odds", "SE")

GoutModels <- tmp %>% 
  mutate(across(c(Cohort, Outcome, Predictors, Predictor, Covariates), factor),
         across(c(N, `N case`, `N control`, OR, LCL, UCL, Pval, `log-odds`, SE), as.numeric))

#save(GoutModels, file = here("Output/GoutModels.RData"))

rm(modlist, tmp, tmplist, covariates, covariates2, f, i, j, k, modstring, modstring1, prsnames, variables)
```

```{r SeverityModels, eval = F}
# We need to model the PRS, the PRS without ABCG2, and both ABCG2 variants simultaneously against age at onset and tophi, adjusting for global PCs. It needs to be in males and females separately, and needs to be both adjusted for disease duration (for tophi) and unadjusted. It also needs to run with the 10 oceanian PCs for Polynesian cohorts.

# Onset --------------------------------------------------------
onset_data_list <- list("Aus/NZ European - Male" = data_list[["Aus/NZ European - Gout - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Aus/NZ European - Female" = data_list[["Aus/NZ European - Gout - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "GlobalGout - Male" = data_list[["GlobalGout - Gout - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "GlobalGout - Female" = data_list[["GlobalGout - Gout - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - LASSO - Male" = data_list[["Ardea - LASSO - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - LASSO - Female" = data_list[["Ardea - LASSO - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CLEAR1 - Male" = data_list[["Ardea - CLEAR1 - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CLEAR1 - Female" = data_list[["Ardea - CLEAR1 - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CLEAR2 - Male" = data_list[["Ardea - CLEAR2 - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CLEAR2 - Female" = data_list[["Ardea - CLEAR2 - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CRYSTAL - Male" = data_list[["Ardea - CRYSTAL - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - CRYSTAL - Female" = data_list[["Ardea - CRYSTAL - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - LIGHT - Male" = data_list[["Ardea - LIGHT - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "Ardea - LIGHT - Female" = data_list[["Ardea - LIGHT - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "East Polynesian - Male" = data_list[["East Polynesian - Gout - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "East Polynesian - Female" = data_list[["East Polynesian - Gout - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "East Polynesian - NP - Male" = data_list[["East Polynesian - Gout - NP - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "East Polynesian - NP - Female" = data_list[["East Polynesian - Gout - NP - Female"]] %>% filter(!is.na(AGE1ATK)),
                        "West Polynesian - Male" = data_list[["West Polynesian - Gout - Male"]] %>% filter(!is.na(AGE1ATK)),
                        "West Polynesian - Female" = data_list[["West Polynesian - Gout - Female"]] %>% filter(!is.na(AGE1ATK)))

for(i in length(onset_data_list):1){
  if(nrow(onset_data_list[[i]]) < 20){
    onset_data_list[[i]] <- NULL
  }
}

modlist <- vector("list", length(onset_data_list))
for(i in seq_along(onset_data_list)){
  prsnames <- list("PRS", "PRS_noABCG2", c("rs2231142", "rs10011796"))
  
  covariates <- c()
  
  if(!str_detect(names(onset_data_list)[i], "UK Biobank")){
    covariates <- c(covariates, "Geno.PCVector1", "Geno.PCVector2", "Geno.PCVector3", "Geno.PCVector4", "Geno.PCVector5", "Geno.PCVector6", "Geno.PCVector7", "Geno.PCVector8", "Geno.PCVector9", "Geno.PCVector10")
  }
  
  if(str_detect(names(onset_data_list)[i], "Polynesian")){
    covariates <- c(covariates, "Geno.PCVector1_Oc", "Geno.PCVector2_Oc", "Geno.PCVector3_Oc", "Geno.PCVector4_Oc", "Geno.PCVector5_Oc", "Geno.PCVector6_Oc", "Geno.PCVector7_Oc", "Geno.PCVector8_Oc", "Geno.PCVector9_Oc", "Geno.PCVector10_Oc")
  }
  
  tmplist <- vector("list", length(prsnames))
  
  for(j in seq_along(prsnames)) {
    variables <- c(prsnames[[j]], covariates)
    f <- as.formula(paste("AGE1ATK", paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0("Model_", i, "_", j), lm(f, data = onset_data_list[[i]]))
    # columns will be: Cohort, N, Outcome, Predictors, Predictor, Covariates, Beta, LCL, UCL, Pval, standard error
    modstring1 <- c(names(onset_data_list)[[i]],
                    nrow(onset_data_list[[i]]),
                    "Age at Onset (years)")
    
    modstring <- list()
    if(any(str_detect(prsnames[[j]], "PRS"))) {
      modstring[[1]] <- c(modstring1,
                          paste(prsnames[[j]], collapse = " + "),
                          paste(prsnames[[j]], collapse = " + "),
                          paste(covariates, collapse = " + "),
                          Beta(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          LCL(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          UCL(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]], 2])
    } else{
      for(k in 1:length(prsnames[[j]])){
        modstring[[k]] <- c(modstring1,
                            paste(prsnames[[j]], collapse = " + "),
                            paste(prsnames[[j]][k], collapse = " + "),
                            paste(covariates, collapse = " + "),
                            Beta(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            LCL(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            UCL(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]][k], 2])
      }
    }
    
    tmplist[[j]] <- modstring
  }
  
  modlist[[i]] <- tmplist
}

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "Model_"))
remove <- remove$value
rm(list = remove, remove)


tmp <- modlist %>% 
  flatten() %>% 
  flatten() %>% 
  as.data.frame() %>% 
  data.table::transpose()

colnames(tmp) <- c("Cohort", "N", "Outcome", "Predictors", "Predictor", "Covariates", "Beta", "LCL", "UCL", "Pval", "SE")

OnsetModels <- tmp %>% 
  mutate(across(c(Cohort, Outcome, Predictors, Predictor, Covariates), factor),
         across(c(N, Beta, LCL, UCL, Pval, SE), as.numeric))

save(OnsetModels, file = here("Output/OnsetModels.RData"))

rm(modlist, tmp, tmplist, covariates, f, i, j, k, modstring, modstring1, prsnames, variables)



# Tophi -------------------------------------------------------------------------------
tophi_data_list <- list("Aus/NZ European - Male" = data_list[["Aus/NZ European - Gout - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Aus/NZ European - Female" = data_list[["Aus/NZ European - Gout - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "GlobalGout - Male" = data_list[["GlobalGout - Gout - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "GlobalGout - Female" = data_list[["GlobalGout - Gout - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - LASSO - Male" = data_list[["Ardea - LASSO - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - LASSO - Female" = data_list[["Ardea - LASSO - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - CLEAR1 - Male" = data_list[["Ardea - CLEAR1 - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - CLEAR1 - Female" = data_list[["Ardea - CLEAR1 - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - CLEAR2 - Male" = data_list[["Ardea - CLEAR2 - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - CLEAR2 - Female" = data_list[["Ardea - CLEAR2 - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - LIGHT - Male" = data_list[["Ardea - LIGHT - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "Ardea - LIGHT - Female" = data_list[["Ardea - LIGHT - Female"]] %>% filter(!is.na(TOPHIGOUT)),
                        "East Polynesian - Male" = rbind(data_list[["East Polynesian - Gout - Male"]] %>% filter(!is.na(TOPHIGOUT)), data_list[["East Polynesian - Gout - NP - Male"]] %>% filter(!is.na(TOPHIGOUT))),
                        "East Polynesian - Female" = rbind(data_list[["East Polynesian - Gout - Female"]] %>% filter(!is.na(TOPHIGOUT)), data_list[["East Polynesian - Gout - NP - Female"]] %>% filter(!is.na(TOPHIGOUT))),
                        "West Polynesian - Male" = data_list[["West Polynesian - Gout - Male"]] %>% filter(!is.na(TOPHIGOUT)),
                        "West Polynesian - Female" = data_list[["West Polynesian - Gout - Female"]] %>% filter(!is.na(TOPHIGOUT)))

for(i in length(tophi_data_list):1){
  if(nrow(tophi_data_list[[i]]) < 20){
    tophi_data_list[[i]] <- NULL
  }
}



modlist <- vector("list", length(tophi_data_list))
for(i in seq_along(tophi_data_list)){
  prsnames <- list("PRS", "PRS_noABCG2", c("rs2231142", "rs10011796"))
  
  covariates <- c()
  
  if(!str_detect(names(tophi_data_list)[i], "UK Biobank")){
    covariates <- c(covariates, "Geno.PCVector1", "Geno.PCVector2", "Geno.PCVector3", "Geno.PCVector4", "Geno.PCVector5", "Geno.PCVector6", "Geno.PCVector7", "Geno.PCVector8", "Geno.PCVector9", "Geno.PCVector10")
  }
  
  if(str_detect(names(tophi_data_list)[i], "Polynesian")){
    covariates <- c(covariates, "Geno.PCVector1_Oc", "Geno.PCVector2_Oc", "Geno.PCVector3_Oc", "Geno.PCVector4_Oc", "Geno.PCVector5_Oc", "Geno.PCVector6_Oc", "Geno.PCVector7_Oc", "Geno.PCVector8_Oc", "Geno.PCVector9_Oc", "Geno.PCVector10_Oc")
  }
  
  covariates2 <- c(covariates, "DURATION")
  
  tmplist <- vector("list", 2 * length(prsnames))
  
  for(j in seq_along(prsnames)) {
    variables <- c(prsnames[[j]], covariates)
    f <- as.formula(paste("TOPHIGOUT", paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0("Model_", i, "_", j), glm(f, family = binomial, data = tophi_data_list[[i]]))
    # columns will be: Cohort, N, N case, N control, Outcome, Predictors, Predictor, Covariates, OR, LCL, UCL, Pval, log-odds, standard error
    modstring1 <- c(names(tophi_data_list)[[i]],
                    nrow(tophi_data_list[[i]]),
                    nrow(tophi_data_list[[i]] %>% filter(TOPHIGOUT)),
                    nrow(tophi_data_list[[i]] %>% filter(!TOPHIGOUT)),
                    "Tophi")
    
    modstring <- list()
    if(any(str_detect(prsnames[[j]], "PRS"))) {
      modstring[[1]] <- c(modstring1,
                          paste(prsnames[[j]], collapse = " + "),
                          paste(prsnames[[j]], collapse = " + "),
                          paste(covariates, collapse = " + "),
                          OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          LCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          UCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]]),
                          coef(get(paste0("Model_", i, "_", j)))[[prsnames[[j]]]],
                          summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]], 2])
    } else{
      for(k in 1:length(prsnames[[j]])){
        modstring[[k]] <- c(modstring1,
                            paste(prsnames[[j]], collapse = " + "),
                            paste(prsnames[[j]][k], collapse = " + "),
                            paste(covariates, collapse = " + "),
                            OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            LCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            UCL_OR(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            Pval(get(paste0("Model_", i, "_", j)), prsnames[[j]][k]),
                            coef(get(paste0("Model_", i, "_", j)))[[prsnames[[j]][k]]],
                            summary(get(paste0("Model_", i, "_", j)))$coefficients[prsnames[[j]][k], 2])
      }
    }
    
    tmplist[[j]] <- modstring
    
    variables <- c(prsnames[[j]], covariates2)
    f <- as.formula(paste("TOPHIGOUT", paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0("Model_", i, "_", j, "_adj"), glm(f, family = binomial, data = tophi_data_list[[i]]))
    modstring1 <- c(names(tophi_data_list)[[i]],
                    nrow(tophi_data_list[[i]]),
                    nrow(tophi_data_list[[i]] %>% filter(TOPHIGOUT)),
                    nrow(tophi_data_list[[i]] %>% filter(!TOPHIGOUT)),
                    "Tophi")
    
    modstring <- list()
    if(any(str_detect(prsnames[[j]], "PRS"))) {
      modstring[[1]] <- c(modstring1,
                          paste(prsnames[[j]], collapse = " + "),
                          paste(prsnames[[j]], collapse = " + "),
                          paste(covariates2, collapse = " + "),
                          OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          LCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          UCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          Pval(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]]),
                          coef(get(paste0("Model_", i, "_", j, "_adj")))[[prsnames[[j]]]],
                          summary(get(paste0("Model_", i, "_", j, "_adj")))$coefficients[prsnames[[j]], 2])
    } else{
      for(k in 1:length(prsnames[[j]])){
        modstring[[k]] <- c(modstring1,
                            paste(prsnames[[j]], collapse = " + "),
                            paste(prsnames[[j]][k], collapse = " + "),
                            paste(covariates2, collapse = " + "),
                            OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            LCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            UCL_OR(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            Pval(get(paste0("Model_", i, "_", j, "_adj")), prsnames[[j]][k]),
                            coef(get(paste0("Model_", i, "_", j, "_adj")))[[prsnames[[j]][k]]],
                            summary(get(paste0("Model_", i, "_", j, "_adj")))$coefficients[prsnames[[j]][k], 2])
      }
    }
    
    tmplist[[j + length(prsnames)]] <- modstring
  }
  
  modlist[[i]] <- tmplist
}

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "Model_"))
remove <- remove$value
rm(list = remove, remove)


tmp <- modlist %>% 
  flatten() %>% 
  flatten() %>% 
  as.data.frame() %>% 
  data.table::transpose()

colnames(tmp) <- c("Cohort", "N", "N case", "N control", "Outcome", "Predictors", "Predictor", "Covariates", "OR", "LCL", "UCL", "Pval", "log-odds", "SE")

TophiModels <- tmp %>% 
  mutate(across(c(Cohort, Outcome, Predictors, Predictor, Covariates), factor),
         across(c(N, `N case`, `N control`, OR, LCL, UCL, Pval, `log-odds`, SE), as.numeric))

save(TophiModels, file = here("Output/TophiModels.RData"))

rm(modlist, tmp, tmplist, covariates, covariates2, f, i, j, k, modstring, modstring1, prsnames, variables)
```
