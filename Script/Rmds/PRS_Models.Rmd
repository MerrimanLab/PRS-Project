

```{r dataprep, message = FALSE, warning = FALSE, cache = TRUE}
# Datasets
load(here("Output/anz_euro_pheno_prs.RData"))
load(here("Output/clear_lasso_euro_pheno_prs.RData"))
load(here("Output/control_anz_euro_pheno_prs.RData"))
load(here("Output/control_eastpoly_pheno_prs.RData"))
load(here("Output/control_westpoly_pheno_prs.RData"))
load(here("Output/crystal_euro_pheno_prs.RData"))
load(here("Output/eastpoly_pheno_prs.RData"))
load(here("Output/eurogout_euro_pheno_prs.RData"))
load(here("Output/lasso_other_euro_pheno_prs.RData"))
load(here("Output/light_euro_pheno_prs.RData"))
load(here("Output/westpoly_pheno_prs.RData"))
load(here("Output/ukbb_euro_pheno_prs.RData"))
load(here("Output/ukbb_poly_pheno_prs.RData"))

load(here("Output/UKBB_Gene_OR.RData"))
load(here("Output/Poly_Gene_OR.RData"))


# European cohort prep
anz_gout <- anz_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = "Aus/NZ") %>% 
  select(-Geno.SampleID)

anz_control <- control_anz_euro_pheno_prs %>%
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         GOUT = rep(FALSE, nrow(.)),
         SEX = factor(Pheno.Gender, levels = c("Female", "Male")),
         SURICACID = Pheno.CollectionUrate / 0.05949) %>% 
  rename(IID = Pheno.SampleID,
         AGECOL = Pheno.Age,
         COHORT = Pheno.Study,
         PC1 = Geno.PCVector1,
         PC2 = Geno.PCVector2,
         PC3 = Geno.PCVector3,
         PC4 = Geno.PCVector4,
         PC5 = Geno.PCVector5,
         PC6 = Geno.PCVector6,
         PC7 = Geno.PCVector7,
         PC8 = Geno.PCVector8,
         PC9 = Geno.PCVector9,
         PC10 = Geno.PCVector10) %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, PRS:rs738408, PRS_std)

tmp <- anz_gout %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, PRS:rs738408, PRS_std)

anz_full <- rbind(tmp, anz_control) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

eurogout <- eurogout_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = rep("EuroGout", nrow(.))) %>% 
  select(-Geno.SampleID)


ardea_clear_lasso <- clear_lasso_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = rep("Ardea - CLEAR/LASSO (ULT)", nrow(.))) %>% 
  select(-Geno.SampleID)


ardea_lasso_other <- lasso_other_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = rep("Ardea - LASSO (other)", nrow(.))) %>% 
  select(-Geno.SampleID)


ardea_crystal <- crystal_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = rep("Ardea - CRYSTAL", nrow(.))) %>% 
  select(-Geno.SampleID)


ardea_light <- light_euro_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE),
         COHORT2 = rep("Ardea - LIGHT", nrow(.))) %>% 
  select(-Geno.SampleID)
  

allgout <- rbind(anz_gout, eurogout, ardea_clear_lasso, ardea_crystal, ardea_lasso_other, ardea_light) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(anz_euro_pheno_prs, clear_lasso_euro_pheno_prs, control_anz_euro_pheno_prs, crystal_euro_pheno_prs, eurogout_euro_pheno_prs, lasso_other_euro_pheno_prs, light_euro_pheno_prs, tmp)


# Polynesian cohort prep
eastpoly_gout <- eastpoly_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE)) %>% 
  select(-Geno.SampleID)

eastpoly_control <- control_eastpoly_pheno_prs %>%
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         GOUT = rep(FALSE, nrow(.)),
         SEX = factor(Pheno.Gender, levels = c("Female", "Male")),
         SURICACID = Pheno.CollectionUrate / 0.05949) %>% 
  rename(IID = Pheno.SampleID,
         AGECOL = Pheno.Age,
         COHORT = Pheno.Study,
         PC1 = Geno.PCVector1,
         PC2 = Geno.PCVector2,
         PC3 = Geno.PCVector3,
         PC4 = Geno.PCVector4,
         PC5 = Geno.PCVector5,
         PC6 = Geno.PCVector6,
         PC7 = Geno.PCVector7,
         PC8 = Geno.PCVector8,
         PC9 = Geno.PCVector9,
         PC10 = Geno.PCVector10,
         PC1_Oc = Geno.PCVector1_Oc,
         PC2_Oc = Geno.PCVector2_Oc,
         PC3_Oc = Geno.PCVector3_Oc,
         PC4_Oc = Geno.PCVector4_Oc,
         PC5_Oc = Geno.PCVector5_Oc,
         PC6_Oc = Geno.PCVector6_Oc,
         PC7_Oc = Geno.PCVector7_Oc,
         PC8_Oc = Geno.PCVector8_Oc,
         PC9_Oc = Geno.PCVector9_Oc,
         PC10_Oc = Geno.PCVector10_Oc) %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, Geno.PolynesianGroup, PC1_Oc:PC10_Oc, PRS:PRS_std)

tmp <- eastpoly_gout %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, Geno.PolynesianGroup, PC1_Oc:PC10_Oc, PRS:PRS_std)

eastpoly_full <- rbind(tmp, eastpoly_control) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

westpoly_gout <- westpoly_pheno_prs %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = if_else(NUMATK > 1, TRUE, FALSE)) %>% 
  select(-Geno.SampleID)

westpoly_control <- control_westpoly_pheno_prs %>%
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         GOUT = rep(FALSE, nrow(.)),
         SEX = factor(Pheno.Gender, levels = c("Female", "Male")),
         SURICACID = Pheno.CollectionUrate / 0.05949) %>% 
  rename(IID = Pheno.SampleID,
         AGECOL = Pheno.Age,
         COHORT = Pheno.Study,
         PC1 = Geno.PCVector1,
         PC2 = Geno.PCVector2,
         PC3 = Geno.PCVector3,
         PC4 = Geno.PCVector4,
         PC5 = Geno.PCVector5,
         PC6 = Geno.PCVector6,
         PC7 = Geno.PCVector7,
         PC8 = Geno.PCVector8,
         PC9 = Geno.PCVector9,
         PC10 = Geno.PCVector10,
         PC1_Oc = Geno.PCVector1_Oc,
         PC2_Oc = Geno.PCVector2_Oc,
         PC3_Oc = Geno.PCVector3_Oc,
         PC4_Oc = Geno.PCVector4_Oc,
         PC5_Oc = Geno.PCVector5_Oc,
         PC6_Oc = Geno.PCVector6_Oc,
         PC7_Oc = Geno.PCVector7_Oc,
         PC8_Oc = Geno.PCVector8_Oc,
         PC9_Oc = Geno.PCVector9_Oc,
         PC10_Oc = Geno.PCVector10_Oc) %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, Geno.PolynesianGroup, PC1_Oc:PC10_Oc, PRS:PRS_std)

tmp <- westpoly_gout %>% 
  select(IID, COHORT, SEX, AGECOL, GOUT, SURICACID, PC1:PC10, Geno.PolynesianGroup, PC1_Oc:PC10_Oc, PRS:PRS_std)

westpoly_full <- rbind(tmp, westpoly_control) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(control_eastpoly_pheno_prs, control_westpoly_pheno_prs, eastpoly_pheno_prs, westpoly_pheno_prs, tmp)


# UK Biobank prep
ukbb_gout <- ukbb_euro_pheno_prs %>% 
  filter(GOUT == TRUE,
         !is.na(PRS)) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = rep(NA, nrow(.)),
         NUMATK = rep(NA, nrow(.)),
         TOPHIGOUT = rep(NA, nrow(.)),
         AGE1ATK = rep(NA, nrow(.)),
         DURATION = rep(NA, nrow(.)),
         PC1 = rep(NA, nrow(.)),
         PC2 = rep(NA, nrow(.)),
         PC3 = rep(NA, nrow(.)),
         PC4 = rep(NA, nrow(.)),
         PC5 = rep(NA, nrow(.)),
         PC6 = rep(NA, nrow(.)),
         PC7 = rep(NA, nrow(.)),
         PC8 = rep(NA, nrow(.)),
         PC9 = rep(NA, nrow(.)),
         PC10 = rep(NA, nrow(.))) %>% 
  select(IID, NUMATK, TOPHIGOUT, AGE1ATK, DURATION, COHORT, SEX, AGECOL, GOUT, SURICACID, ULT, PC1:PC10, PRS:PRS_std, FLAREHIGH)

ukbb_control <- ukbb_euro_pheno_prs %>% 
  filter(GOUT == FALSE,
         !is.na(PRS)) %>%
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = rep(NA, nrow(.)),
         NUMATK = rep(NA, nrow(.)),
         TOPHIGOUT = rep(NA, nrow(.)),
         AGE1ATK = rep(NA, nrow(.)),
         DURATION = rep(NA, nrow(.)),
         PC1 = rep(NA, nrow(.)),
         PC2 = rep(NA, nrow(.)),
         PC3 = rep(NA, nrow(.)),
         PC4 = rep(NA, nrow(.)),
         PC5 = rep(NA, nrow(.)),
         PC6 = rep(NA, nrow(.)),
         PC7 = rep(NA, nrow(.)),
         PC8 = rep(NA, nrow(.)),
         PC9 = rep(NA, nrow(.)),
         PC10 = rep(NA, nrow(.)),
         ULT = rep(NA, nrow(.))) %>% 
  select(IID, NUMATK, TOPHIGOUT, AGE1ATK, DURATION, COHORT, SEX, AGECOL, GOUT, SURICACID, ULT, PC1:PC10, PRS:PRS_std, FLAREHIGH)

ukbb <- rbind(ukbb_gout, ukbb_control) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(ukbb_euro_pheno_prs)

ukbb_gout_poly <- ukbb_poly_pheno_prs %>% 
  filter(GOUT == TRUE,
         !is.na(PRS)) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = rep(NA, nrow(.)),
         NUMATK = rep(NA, nrow(.)),
         TOPHIGOUT = rep(NA, nrow(.)),
         AGE1ATK = rep(NA, nrow(.)),
         DURATION = rep(NA, nrow(.)),
         PC1 = rep(NA, nrow(.)),
         PC2 = rep(NA, nrow(.)),
         PC3 = rep(NA, nrow(.)),
         PC4 = rep(NA, nrow(.)),
         PC5 = rep(NA, nrow(.)),
         PC6 = rep(NA, nrow(.)),
         PC7 = rep(NA, nrow(.)),
         PC8 = rep(NA, nrow(.)),
         PC9 = rep(NA, nrow(.)),
         PC10 = rep(NA, nrow(.))) %>% 
  select(IID, NUMATK, TOPHIGOUT, AGE1ATK, DURATION, COHORT, SEX, AGECOL, GOUT, SURICACID, ULT, PC1:PC10, PRS:PRS_std, FLAREHIGH)

ukbb_control_poly <- ukbb_poly_pheno_prs %>% 
  filter(GOUT == FALSE,
         !is.na(PRS)) %>%
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS),
         FLAREHIGH = rep(NA, nrow(.)),
         NUMATK = rep(NA, nrow(.)),
         TOPHIGOUT = rep(NA, nrow(.)),
         AGE1ATK = rep(NA, nrow(.)),
         DURATION = rep(NA, nrow(.)),
         PC1 = rep(NA, nrow(.)),
         PC2 = rep(NA, nrow(.)),
         PC3 = rep(NA, nrow(.)),
         PC4 = rep(NA, nrow(.)),
         PC5 = rep(NA, nrow(.)),
         PC6 = rep(NA, nrow(.)),
         PC7 = rep(NA, nrow(.)),
         PC8 = rep(NA, nrow(.)),
         PC9 = rep(NA, nrow(.)),
         PC10 = rep(NA, nrow(.)),
         ULT = rep(NA, nrow(.))) %>% 
  select(IID, NUMATK, TOPHIGOUT, AGE1ATK, DURATION, COHORT, SEX, AGECOL, GOUT, SURICACID, ULT, PC1:PC10, PRS:PRS_std, FLAREHIGH)

ukbb_poly <- rbind(ukbb_gout_poly, ukbb_control_poly) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(ukbb_poly_pheno_prs)


# Functions
logistic_model <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), glm(f, family = "binomial", data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_model_ukbb <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates)
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), glm(f, family = "binomial", data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_model_poly <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC1_Oc", "PC2_Oc", "PC3_Oc", "PC4_Oc", "PC5_Oc", "PC6_Oc", "PC7_Oc", "PC8_Oc", "PC9_Oc", "PC10_Oc")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), glm(f, family = "binomial", data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

linear_model <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), lm(f, data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

linear_model_ukbb <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates)
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), lm(f, data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

linear_model_poly <- function(dataset, outcome, covariates, modelname){
  grsnames <- colnames(select(dataset, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC1_Oc", "PC2_Oc", "PC3_Oc", "PC4_Oc", "PC5_Oc", "PC6_Oc", "PC7_Oc", "PC8_Oc", "PC9_Oc", "PC10_Oc")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    assign(paste0(modelname, i), lm(f, data = dataset))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

linear_meta <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- lm(f, data = anz_gout)
    tmp2 <- lm(f, data = eurogout)
    tmp3 <- lm(f, data = ardea_clear_lasso)
    tmp4 <- lm(f, data = ardea_lasso_other)
    tmp5 <- lm(f, data = ardea_crystal)
    tmp6 <- lm(f, data = ardea_light)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]], tmp6$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2], summary(tmp6)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout", "Ardea - CLEAR/LASSO (ULT)", "Ardea - LASSO (other)", "Ardea - CRYSTAL", "Ardea - LIGHT"))))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_meta <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- glm(f, family = "binomial", data = anz_gout)
    tmp2 <- glm(f, family = "binomial", data = eurogout)
    tmp3 <- glm(f, family = "binomial", data = ardea_clear_lasso)
    tmp4 <- glm(f, family = "binomial", data = ardea_lasso_other)
    tmp5 <- glm(f, family = "binomial", data = ardea_crystal)
    tmp6 <- glm(f, family = "binomial", data = ardea_light)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]], tmp6$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2], summary(tmp6)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout", "Ardea - CLEAR/LASSO (ULT)", "Ardea - LASSO (other)", "Ardea - CRYSTAL", "Ardea - LIGHT"), sm = "OR")))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_meta_tophi <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- glm(f, family = "binomial", data = anz_gout)
    tmp2 <- glm(f, family = "binomial", data = eurogout)
    tmp3 <- glm(f, family = "binomial", data = ardea_clear_lasso)
    tmp4 <- glm(f, family = "binomial", data = ardea_lasso_other)
    tmp5 <- glm(f, family = "binomial", data = ardea_light)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout", "Ardea - CLEAR/LASSO (ULT)", "Ardea - LASSO (other)", "Ardea - LIGHT"), sm = "OR")))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_meta_noardea <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- glm(f, family = "binomial", data = anz_gout)
    tmp2 <- glm(f, family = "binomial", data = eurogout)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout"), sm = "OR")))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

clean_lapply <- function(modelname, functionname){
  unlist(lapply(get(paste0(modelname, "modlist")), functionname))
}

OR <- function(x) {
  sprintf(exp(coef(x))[[2]], fmt = "%#.4f")
}

CI_OR <- function(x) {
  paste0("[", sprintf(exp(confint.default(x))[2, 1], fmt = "%#.4f"), ", ", sprintf(exp(confint.default(x))[2, 2], fmt = "%#.4f"), "]")
}

Print_beta <- function(x) {
  sprintf(coef(x)[[2]], fmt = "%#.4f")
}

CI_beta <- function(x) {
  paste0("[", sprintf(confint.default(x)[2, 1], fmt = "%#.4f"), ", ", sprintf(confint.default(x)[2, 2], fmt = "%#.4f"), "]")
}

Pval <- function(x) {
  signif(summary(x)$coefficients[2, 4], 3)
}

OR_meta <- function(x) {
  sprintf(exp(x$TE.fixed), fmt = "%#.4f")
}

CI_OR_meta <- function(x) {
  paste0("[", sprintf(exp(x$lower.fixed), fmt = "%#.4f"), ", ", sprintf(exp(x$upper.fixed), fmt = "%#.4f"), "]")
}

Print_beta_meta <- function(x) {
  sprintf(x$TE.fixed, fmt = "%#.4f")
}

CI_beta_meta <- function(x) {
  paste0("[", sprintf(x$lower.fixed, fmt = "%#.4f"), ", ", sprintf(x$upper.fixed, fmt = "%#.4f"), "]")
}

Pval_meta <- function(x) {
  signif(x$pval.fixed, 3)
}
```

```{r Assumptions}
# Regression has the following assumptions:
# 1. No multicollinearity
# 2. Homoscedasticity of residuals (for linear regressions)
# 3. Linear relationship between variables (for linear regressions)
# 4. Normality of outcome/residuals (for linear regressions)

# These should probably be tested for all models, but I might be able to just test some representative models instead

# The easiest assumption to test is normality of the linear outcomes (age at onset and flares)
# This should be tested in each cohort individually and pooled
# Age at onset first
# Freqpoly's
ggplot(allgout, aes(x = AGE1ATK)) + 
  geom_freqpoly(aes(y = ..density.., color = COHORT2), binwidth = 5)

ggplot(allgout, aes(x = AGE1ATK)) + 
  geom_freqpoly(aes(y = ..density..), color = "black", binwidth = 5)

# Boxplots
ggplot(allgout, aes(y = AGE1ATK)) + 
  geom_boxplot(fill = "gray", color = "black") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  facet_wrap(~ COHORT2, scales = "free")

ggplot(allgout, aes(y = AGE1ATK)) + 
  geom_boxplot(fill = "gray", color = "black") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

# QQ-plots
ggplot(allgout) + 
  geom_qq(aes(sample = AGE1ATK)) +
  geom_qq_line(aes(sample = AGE1ATK)) +
  facet_wrap(~ COHORT2, scales = "free")

ggplot(allgout) + 
  geom_qq(aes(sample = AGE1ATK)) +
  geom_qq_line(aes(sample = AGE1ATK))

# Statistics
t(aggregate(allgout$AGE1ATK, by = list(allgout$COHORT2), stat.desc, basic = FALSE, desc = FALSE, norm = TRUE))

stat.desc(allgout$AGE1ATK, basic = FALSE, desc = FALSE, norm = TRUE)

# Even though the stats suggest non-normality, I would say it is close to normality based on the plots

# Now flare frequency
# Histograms
ggplot(allgout, aes(x = NUMATK)) + 
  geom_freqpoly(aes(y = ..density.., color = COHORT2), binwidth = 1) +
  scale_x_continuous(lim = c(0, 52))

ggplot(allgout, aes(x = NUMATK)) + 
  geom_freqpoly(aes(y = ..density..), color = "black", binwidth = 1) +
  scale_x_continuous(lim = c(0, 52))

# Boxplots
ggplot(allgout, aes(y = NUMATK)) + 
  geom_boxplot(fill = "gray", color = "black") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  facet_wrap(~ COHORT2, scales = "free")

ggplot(allgout, aes(y = NUMATK)) + 
  geom_boxplot(fill = "gray", color = "black") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  ylim(c(0, 52))

# QQ-plots
ggplot(allgout) + 
  geom_qq(aes(sample = NUMATK)) +
  geom_qq_line(aes(sample = NUMATK)) +
  facet_wrap(~ COHORT2, scales = "free")

ggplot(allgout) + 
  geom_qq(aes(sample = NUMATK)) +
  geom_qq_line(aes(sample = NUMATK))

# Statistics
t(aggregate(allgout$NUMATK, by = list(allgout$COHORT2), stat.desc, basic = FALSE, desc = FALSE, norm = TRUE))

stat.desc(allgout$NUMATK, basic = FALSE, desc = FALSE, norm = TRUE)

# Clearly extremely positively skewed, perhaps transform it with square root or log
ggplot(allgout, aes(x = sqrt(NUMATK))) + 
  geom_histogram(aes(y = ..density..), fill = "gray", color = "black") +
  facet_wrap(~ COHORT2, scales = "free")

ggplot(allgout, aes(x = log(NUMATK))) + 
  geom_histogram(aes(y = ..density..), fill = "gray", color = "black") +
  facet_wrap(~ COHORT2, scales = "free")
# Clearly both still non-normal. This variable really just can't be used for linear regression

# For testing linearity between onset and the GRS, it seemed close based on the data exploration plots. There is evidence for a sigmoidal shape though this shouldn't void the assumption

# Now homoscedasticity of residuals can be tested in representative models:
mod1 <- lm(AGE1ATK ~ PRS + SEX, data = allgout)
model_df <- broom::augment(mod1)
ggplot(data = model_df, aes(x = .fitted, y = .resid)) + geom_point() + geom_hline(yintercept = 0)

mod1 <- lm(AGE1ATK ~ PRS + SEX, data = anz_gout)
model_df <- broom::augment(mod1)
ggplot(data = model_df, aes(x = .fitted, y = .resid)) + geom_point() + geom_hline(yintercept = 0)

mod1 <- lm(AGE1ATK ~ PRS + SEX, data = eurogout)
model_df <- broom::augment(mod1)
ggplot(data = model_df, aes(x = .fitted, y = .resid)) + geom_point() + geom_hline(yintercept = 0)

mod1 <- lm(AGE1ATK ~ PRS + SEX, data = ardea_clear_lasso)
model_df <- broom::augment(mod1)
ggplot(data = model_df, aes(x = .fitted, y = .resid)) + geom_point() + geom_hline(yintercept = 0)
# They all seem to be fairly evenly spread
rm(mod1, model_df)

# Finally, multicollinearity should not be an issue because I have made sure not to include variables that are too highly correlated with eachother within the same model (i.e. age at collection and age at onset)

# I will additionally look at the goodness of fit of the logistic models for tophi and flare positivity/activity
mod <- glm(TOPHIGOUT ~ PRS + AGECOL + SEX, data = allgout)
with(mod, pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)) # p-value of 0.06 suggests that the model does not fit better than an empty model

mod <- glm(FLAREHIGH ~ PRS + AGECOL + SEX, data = allgout)
with(mod, pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)) # p-value of 7.7e-9 suggests that the model does fit better than an empty model

rm(mod)
```

```{r GoutModels, echo = FALSE}
# Modeling Gout + Serum urate vs PRS in Aus/NZ Europeans and UK Biobank
# Also modelling Gout adjusted for SU and SU in gout cohorts
logistic_model(anz_full, "GOUT", c("SEX", "AGECOL"), "GOUTanz")

logistic_model_ukbb(ukbb, "GOUT", c("SEX", "AGECOL"), "GOUTukbb")


logistic_model(anz_full, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTanz")

logistic_model_ukbb(ukbb, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTukbb")


linear_model(anz_full, "SURICACID", c("SEX", "AGECOL"), "URATEanz")

linear_model_ukbb(ukbb, "SURICACID", c("SEX", "AGECOL"), "URATEukbb")


linear_model(anz_gout, "SURICACID", c("SEX", "AGECOL"), "URATEanz_gout")

linear_model_ukbb(ukbb_gout, "SURICACID", c("SEX", "AGECOL"), "URATEukbb_gout")


linear_model(anz_control, "SURICACID", c("SEX", "AGECOL"), "URATEanz_control")

linear_model_ukbb(ukbb_control, "SURICACID", c("SEX", "AGECOL"), "URATEukbb_control")


linear_model(ardea_clear_lasso, "SURICACID", c("SEX", "AGECOL"), "URATEardea_clear_lasso")

linear_model(ardea_lasso_other, "SURICACID", c("SEX", "AGECOL"), "URATEardea_lasso_other")

linear_model(ardea_crystal, "SURICACID", c("SEX", "AGECOL"), "URATEardea_crystal")

linear_model(ardea_light, "SURICACID", c("SEX", "AGECOL"), "URATEardea_light")

linear_model(eurogout, "SURICACID", c("SEX", "AGECOL"), "URATEeurogout")

linear_model(allgout, "SURICACID", c("SEX", "AGECOL"), "URATEallgout")


# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Gout", 4*x),
                   rep("Serum urate", 12*x))

PredictorString <- rep(grsnames, 16)

CovariateString <- c(rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Age + 10 PCs", 12*x))

CohortString <- c(rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ - gout", x),
                  rep("UK Biobank - gout", x),
                  rep("Aus/NZ - control", x),
                  rep("UK Biobank - control", x),
                  rep("Ardea - CLEAR + LASSO (ULT)", x),
                  rep("Ardea - LASSO (other)", x),
                  rep("Ardea - CRYSTAL", x),
                  rep("Ardea - LIGHT", x),
                  rep("GlobalGout", x),
                  rep("Pooled European Gout (no UKBB)", x))

ORString <- c(clean_lapply("GOUTanz", OR),
              clean_lapply("GOUTukbb", OR),
              clean_lapply("suGOUTanz", OR),
              clean_lapply("suGOUTukbb", OR),
              rep(NAString, 12))

BetaString <- c(rep(NAString, 4),
                clean_lapply("URATEanz", Print_beta),
                clean_lapply("URATEukbb", Print_beta),
                clean_lapply("URATEanz_gout", Print_beta),
                clean_lapply("URATEukbb_gout", Print_beta),
                clean_lapply("URATEanz_control", Print_beta),
                clean_lapply("URATEukbb_control", Print_beta),
                clean_lapply("URATEardea_clear_lasso", Print_beta),
                clean_lapply("URATEardea_lasso_other", Print_beta),
                clean_lapply("URATEardea_crystal", Print_beta),
                clean_lapply("URATEardea_light", Print_beta),
                clean_lapply("URATEeurogout", Print_beta),
                clean_lapply("URATEallgout", Print_beta))

CIString <- c(clean_lapply("GOUTanz", CI_OR),
              clean_lapply("GOUTukbb", CI_OR),
              clean_lapply("suGOUTanz", CI_OR),
              clean_lapply("suGOUTukbb", CI_OR),
              clean_lapply("URATEanz", CI_beta),
              clean_lapply("URATEukbb", CI_beta),
              clean_lapply("URATEanz_gout", CI_beta),
              clean_lapply("URATEukbb_gout", CI_beta),
              clean_lapply("URATEanz_control", CI_beta),
              clean_lapply("URATEukbb_control", CI_beta),
              clean_lapply("URATEardea_clear_lasso", CI_beta),
              clean_lapply("URATEardea_lasso_other", CI_beta),
              clean_lapply("URATEardea_crystal", CI_beta),
              clean_lapply("URATEardea_light", CI_beta),
              clean_lapply("URATEeurogout", CI_beta),
              clean_lapply("URATEallgout", CI_beta))

PvalString <- c(clean_lapply("GOUTanz", Pval),
                clean_lapply("GOUTukbb", Pval),
                clean_lapply("suGOUTanz", Pval),
                clean_lapply("suGOUTukbb", Pval),
                clean_lapply("URATEanz", Pval),
                clean_lapply("URATEukbb", Pval),
                clean_lapply("URATEanz_gout", Pval),
                clean_lapply("URATEukbb_gout", Pval),
                clean_lapply("URATEanz_control", Pval),
                clean_lapply("URATEukbb_control", Pval),
                clean_lapply("URATEardea_clear_lasso", Pval),
                clean_lapply("URATEardea_lasso_other", Pval),
                clean_lapply("URATEardea_crystal", Pval),
                clean_lapply("URATEardea_light", Pval),
                clean_lapply("URATEeurogout", Pval),
                clean_lapply("URATEallgout", Pval))

GoutvsPRS <- tibble("Outcome" = OutcomeString,
                    "Predictor" = PredictorString,
                    "Covariates" = CovariateString, 
                    "Cohort" = CohortString, 
                    "OR" = ORString, 
                    "Beta" = BetaString, 
                    "95% CI" = CIString, 
                    "Pval" = PvalString)
GoutvsPRS <- GoutvsPRS %>% mutate("Signif." = case_when(Pval < 2.38e-3 ~ "**", Pval >= 2.38e-3 & Pval < 0.05 ~ "*", TRUE ~ "-"))
save(GoutvsPRS, file = here("Output/GoutvsPRS.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)


# Modeling Gout + Serum urate vs PRS in East and West Polynesians
# Also modelling Gout adjusted for SU and SU in gout cohorts
logistic_model_poly(eastpoly_full, "GOUT", c("SEX", "AGECOL"), "GOUTeast")

logistic_model_poly(westpoly_full, "GOUT", c("SEX", "AGECOL"), "GOUTwest")


logistic_model_poly(eastpoly_full, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTeast")

logistic_model_poly(westpoly_full, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTwest")


linear_model_poly(eastpoly_full, "SURICACID", c("SEX", "AGECOL"), "URATEeast")

linear_model_poly(westpoly_full, "SURICACID", c("SEX", "AGECOL"), "URATEwest")


linear_model_poly(eastpoly_gout, "SURICACID", c("SEX", "AGECOL"), "URATEeast_gout")

linear_model_poly(westpoly_gout, "SURICACID", c("SEX", "AGECOL"), "URATEwest_gout")


linear_model_poly(eastpoly_control, "SURICACID", c("SEX", "AGECOL"), "URATEeast_control")

linear_model_poly(westpoly_control, "SURICACID", c("SEX", "AGECOL"), "URATEwest_control")


# Creating table of results
grsnames <- colnames(select(eastpoly_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Gout", 4*x),
                   rep("Serum urate", 6*x))

PredictorString <- rep(grsnames, 10)

CovariateString <- c(rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 6*x))

CohortString <- c(rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian - gout", x),
                  rep("West Polynesian - gout", x),
                  rep("East Polynesian - control", x),
                  rep("West Polynesian - control", x))

ORString <- c(clean_lapply("GOUTeast", OR),
              clean_lapply("GOUTwest", OR),
              clean_lapply("suGOUTeast", OR),
              clean_lapply("suGOUTwest", OR),
              rep(NAString, 6))

BetaString <- c(rep(NAString, 4),
                clean_lapply("URATEeast", Print_beta),
                clean_lapply("URATEwest", Print_beta),
                clean_lapply("URATEeast_gout", Print_beta),
                clean_lapply("URATEwest_gout", Print_beta),
                clean_lapply("URATEeast_control", Print_beta),
                clean_lapply("URATEwest_control", Print_beta))

CIString <- c(clean_lapply("GOUTeast", CI_OR),
              clean_lapply("GOUTwest", CI_OR),
              clean_lapply("suGOUTeast", CI_OR),
              clean_lapply("suGOUTwest", CI_OR),
              clean_lapply("URATEeast", CI_beta),
              clean_lapply("URATEwest", CI_beta),
              clean_lapply("URATEeast_gout", CI_beta),
              clean_lapply("URATEwest_gout", CI_beta),
              clean_lapply("URATEeast_control", CI_beta),
              clean_lapply("URATEwest_control", CI_beta))

PvalString <- c(clean_lapply("GOUTeast", Pval),
                clean_lapply("GOUTwest", Pval),
                clean_lapply("suGOUTeast", Pval),
                clean_lapply("suGOUTwest", Pval),
                clean_lapply("URATEeast", Pval),
                clean_lapply("URATEwest", Pval),
                clean_lapply("URATEeast_gout", Pval),
                clean_lapply("URATEwest_gout", Pval),
                clean_lapply("URATEeast_control", Pval),
                clean_lapply("URATEwest_control", Pval))

GoutvsPRS_Poly <- tibble("Outcome" = OutcomeString,
                        "Predictor" = PredictorString,
                        "Covariates" = CovariateString, 
                        "Cohort" = CohortString, 
                        "OR" = ORString, 
                        "Beta" = BetaString, 
                        "95% CI" = CIString, 
                        "Pval" = PvalString)
GoutvsPRS_Poly <- GoutvsPRS_Poly %>% mutate("Signif." = case_when(Pval < 2.38e-3 ~ "**", Pval >= 2.38e-3 & Pval < 0.05 ~ "*", TRUE ~ "-"))
save(GoutvsPRS_Poly, file = here("Output/GoutvsPRS_Poly.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)
```

```{r MainSeverityModels, echo = FALSE}
# European Meta-analyses
linear_meta("AGE1ATK", c("SEX"), "metaONSET")

linear_meta("AGE1ATK", c("SEX", "SURICACID"), "sumetaONSET")

logistic_meta_tophi("TOPHIGOUT", c("SEX", "AGECOL"), "metaTOPHI")

logistic_meta_tophi("TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "sumetaTOPHI")

logistic_meta_tophi("TOPHIGOUT", c("SEX", "DURATION"), "durmetaTOPHI")

logistic_meta_noardea("FLAREHIGH", c("SEX", "AGECOL"), "metaFLARE")

logistic_meta_noardea("FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "sumetaFLARE")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)



OutcomeString <- c(rep("Age at onset (years)", 2*x),
                   rep("Presence of tophi", 3*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x))

PredictorString <- rep(grsnames, 7)

CovariateString <- c(rep("Sex + 10 PCs", x),
                     rep("Sex + Serum urate + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", x),
                     rep("Sex + Age + Serum urate + 10 PCs", x),
                     rep("Sex + Disease duration + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", x),
                     rep("Sex + Age + Serum urate + 10 PCs", x))

CohortString <- c(rep("European Gout (Meta-analysis)", 2*x),
                  rep("European Gout (Meta-analysis) - no CRYSTAL", 3*x),
                  rep("European Gout (Meta-analysis) - no Ardea", 2*x))

ORString <- c(rep(NAString, 2),
              clean_lapply("metaTOPHI", OR_meta),
              clean_lapply("sumetaTOPHI", OR_meta),
              clean_lapply("durmetaTOPHI", OR_meta),
              clean_lapply("metaFLARE", OR_meta),
              clean_lapply("sumetaFLARE", OR_meta))

BetaString <- c(clean_lapply("metaONSET", Print_beta_meta),
                clean_lapply("sumetaONSET", Print_beta_meta),
                rep(NAString, 5))

CIString <- c(clean_lapply("metaONSET", CI_beta_meta),
              clean_lapply("sumetaONSET", CI_beta_meta),
              clean_lapply("metaTOPHI", CI_OR_meta),
              clean_lapply("sumetaTOPHI", CI_OR_meta),
              clean_lapply("durmetaTOPHI", CI_OR_meta),
              clean_lapply("metaFLARE", CI_OR_meta),
              clean_lapply("sumetaFLARE", CI_OR_meta))

PvalString <- c(clean_lapply("metaONSET", Pval_meta),
                clean_lapply("sumetaONSET", Pval_meta),
                clean_lapply("metaTOPHI", Pval_meta),
                clean_lapply("sumetaTOPHI", Pval_meta),
                clean_lapply("durmetaTOPHI", Pval_meta),
                clean_lapply("metaFLARE", Pval_meta),
                clean_lapply("sumetaFLARE", Pval_meta))

Meta3traitsvsPRS <- tibble("Outcome" = OutcomeString,
                           "Predictor" = PredictorString,
                           "Covariates" = CovariateString, 
                           "Cohort" = CohortString, 
                           "OR" = ORString, 
                           "Beta" = BetaString, 
                           "95% CI" = CIString, 
                           "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))

save(Meta3traitsvsPRS, file = here("Output/Meta3traitsvsPRS.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)



# Now for European pooled analyses
linear_model(allgout, "AGE1ATK", c("SEX"), "ONSETallgout")


linear_model(allgout, "AGE1ATK", c("SEX", "SURICACID"), "suONSETallgout")


logistic_model(allgout, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIallgout")


logistic_model(allgout, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREallgout")


logistic_model(allgout, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIallgout")


logistic_model(allgout, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREallgout")


logistic_model(allgout, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIallgout")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Age at onset (years)", 2*x),
                   rep("Presence of tophi", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Presence of tophi", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Presence of tophi", x))

PredictorString <- rep(grsnames, 7)

CovariateString <- c(rep("Sex + 10 PCs", x),
                     rep("Sex + Serum urate + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Disease duration + 10 PCs", x))

CohortString <- rep("Pooled Europeans", 7*x)

ORString <- c(rep(NAString, 2),
              clean_lapply("TOPHIallgout", OR),
              clean_lapply("FLAREallgout", OR),
              clean_lapply("suTOPHIallgout", OR),
              clean_lapply("suFLAREallgout", OR),
              clean_lapply("durTOPHIallgout", OR))

BetaString <- c(clean_lapply("ONSETallgout", Print_beta),
                clean_lapply("suONSETallgout", Print_beta),
                rep(NAString, 5))

CIString <- c(clean_lapply("ONSETallgout", CI_beta),
              clean_lapply("suONSETallgout", CI_beta),
              clean_lapply("TOPHIallgout", CI_OR),
              clean_lapply("FLAREallgout", CI_OR),
              clean_lapply("suTOPHIallgout", CI_OR),
              clean_lapply("suFLAREallgout", CI_OR),
              clean_lapply("durTOPHIallgout", CI_OR))

PvalString <- c(clean_lapply("ONSETallgout", Pval),
                clean_lapply("suONSETallgout", Pval),
                clean_lapply("TOPHIallgout", Pval),
                clean_lapply("FLAREallgout", Pval),
                clean_lapply("suTOPHIallgout", Pval),
                clean_lapply("suFLAREallgout", Pval),
                clean_lapply("durTOPHIallgout", Pval))

PooledvsPRS <- tibble("Outcome" = OutcomeString,
                      "Predictor" = PredictorString,
                      "Covariates" = CovariateString, 
                      "Cohort" = CohortString, 
                      "OR" = ORString, 
                      "Beta" = BetaString, 
                      "95% CI" = CIString, 
                      "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))

save(PooledvsPRS, file = here("Output/PooledvsPRS.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)


# Now for Polynesian pooled analyses
linear_model_poly(eastpoly_gout, "AGE1ATK", c("SEX"), "ONSETeast")

linear_model_poly(westpoly_gout, "AGE1ATK", c("SEX"), "ONSETwest")

linear_model_poly(eastpoly_gout, "AGE1ATK", c("SEX", "SURICACID"), "suONSETeast")

linear_model_poly(westpoly_gout, "AGE1ATK", c("SEX", "SURICACID"), "suONSETwest")

logistic_model_poly(eastpoly_gout, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIeast")

logistic_model_poly(westpoly_gout, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIwest")

logistic_model_poly(eastpoly_gout, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREeast")

logistic_model_poly(westpoly_gout, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREwest")

logistic_model_poly(eastpoly_gout, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIeast")

logistic_model_poly(westpoly_gout, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIwest")

logistic_model_poly(eastpoly_gout, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREeast")

logistic_model_poly(westpoly_gout, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREwest")

logistic_model_poly(eastpoly_gout, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIeast")

logistic_model_poly(westpoly_gout, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIwest")


# Creating table of results
grsnames <- colnames(select(eastpoly_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Age at onset (years)", 4*x),
                   rep("Presence of tophi", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Presence of tophi", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Presence of tophi", 2*x))

PredictorString <- rep(grsnames, 14)

CovariateString <- c(rep("Sex + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Serum urate + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Disease duration + 10 Global PCs + 10 Oceanian PCs", 2*x))

CohortString <- rep(c(rep("East Polynesian gout", x), 
                      rep("West Polynesian gout", x)), 7)

ORString <- c(rep(NAString, 4),
              clean_lapply("TOPHIeast", OR),
              clean_lapply("TOPHIwest", OR),
              clean_lapply("FLAREeast", OR),
              clean_lapply("FLAREwest", OR),
              clean_lapply("suTOPHIeast", OR),
              clean_lapply("suTOPHIwest", OR),
              clean_lapply("suFLAREeast", OR),
              clean_lapply("suFLAREwest", OR),
              clean_lapply("durTOPHIeast", OR),
              clean_lapply("durTOPHIwest", OR))

BetaString <- c(clean_lapply("ONSETeast", Print_beta),
                clean_lapply("ONSETwest", Print_beta),
                clean_lapply("suONSETeast", Print_beta),
                clean_lapply("suONSETwest", Print_beta),
                rep(NAString, 10))

CIString <- c(clean_lapply("ONSETeast", CI_beta),
              clean_lapply("ONSETwest", CI_beta),
              clean_lapply("suONSETeast", CI_beta),
              clean_lapply("suONSETwest", CI_beta),
              clean_lapply("TOPHIeast", CI_OR),
              clean_lapply("TOPHIwest", CI_OR),
              clean_lapply("FLAREeast", CI_OR),
              clean_lapply("FLAREwest", CI_OR),
              clean_lapply("suTOPHIeast", CI_OR),
              clean_lapply("suTOPHIwest", CI_OR),
              clean_lapply("suFLAREeast", CI_OR),
              clean_lapply("suFLAREwest", CI_OR),
              clean_lapply("durTOPHIeast", CI_OR),
              clean_lapply("durTOPHIwest", CI_OR))

PvalString <- c(clean_lapply("ONSETeast", Pval),
                clean_lapply("ONSETwest", Pval),
                clean_lapply("suONSETeast", Pval),
                clean_lapply("suONSETwest", Pval),
                clean_lapply("TOPHIeast", Pval),
                clean_lapply("TOPHIwest", Pval),
                clean_lapply("FLAREeast", Pval),
                clean_lapply("FLAREwest", Pval),
                clean_lapply("suTOPHIeast", Pval),
                clean_lapply("suTOPHIwest", Pval),
                clean_lapply("suFLAREeast", Pval),
                clean_lapply("suFLAREwest", Pval),
                clean_lapply("durTOPHIeast", Pval),
                clean_lapply("durTOPHIwest", Pval))

PooledvsPRS_Poly <- tibble("Outcome" = OutcomeString,
                           "Predictor" = PredictorString,
                           "Covariates" = CovariateString, 
                           "Cohort" = CohortString, 
                           "OR" = ORString, 
                           "Beta" = BetaString, 
                           "95% CI" = CIString, 
                           "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                                     Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                                     TRUE ~ "-"))

save(PooledvsPRS_Poly, file = here("Output/PooledvsPRS_Poly.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)
```

```{r ColliderAnalysis, echo = FALSE}
# Tony suggested we could do a pooled analysis with UK Biobank controls to account for collider bias
# Preparing the cohorts
tmp <- ukbb_control %>% 
  mutate(FLAREHIGH = FALSE,
         TOPHIGOUT = FALSE,
         FLARELOW = FALSE,
         NONTOPHIGOUT = FALSE)

tmp2 <- allgout %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT) %>% 
  select(-COHORT2)

fullcohort <- rbind(tmp, tmp2) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(tmp, tmp2)



# Running the models
logistic_model_ukbb(fullcohort, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIfullcohort")


logistic_model_ukbb(fullcohort, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIfullcohort")


logistic_model_ukbb(fullcohort, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIfullcohort")


logistic_model_ukbb(fullcohort, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIfullcohort")


logistic_model_ukbb(fullcohort, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHfullcohort")


logistic_model_ukbb(fullcohort, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWfullcohort")


logistic_model_ukbb(fullcohort, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHfullcohort")


logistic_model_ukbb(fullcohort, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWfullcohort")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Tophaceous gout", x),
                   rep("Non-tophaceous gout", x),
                   rep("Tophaceous gout", x),
                   rep("Non-tophaceous gout", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Low activity gout (< 2 flares/year)", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Low activity gout (< 2 flares/year)", x))

PredictorString <- rep(grsnames, 8)

CovariateString <- c(rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x))

CohortString <- rep("Pooled European Gout (no UKBB) + UKBB Controls", 8*x)

ORString <- c(clean_lapply("TOPHIfullcohort", OR),
              clean_lapply("NONTOPHIfullcohort", OR),
              clean_lapply("suTOPHIfullcohort", OR),
              clean_lapply("suNONTOPHIfullcohort", OR),
              clean_lapply("FLAREHIGHfullcohort", OR),
              clean_lapply("FLARELOWfullcohort", OR),
              clean_lapply("suFLAREHIGHfullcohort", OR),
              clean_lapply("suFLARELOWfullcohort", OR))

CIString <- c(clean_lapply("TOPHIfullcohort", CI_OR),
              clean_lapply("NONTOPHIfullcohort", CI_OR),
              clean_lapply("suTOPHIfullcohort", CI_OR),
              clean_lapply("suNONTOPHIfullcohort", CI_OR),
              clean_lapply("FLAREHIGHfullcohort", CI_OR),
              clean_lapply("FLARELOWfullcohort", CI_OR),
              clean_lapply("suFLAREHIGHfullcohort", CI_OR),
              clean_lapply("suFLARELOWfullcohort", CI_OR))

PvalString <- c(clean_lapply("TOPHIfullcohort", Pval),
                clean_lapply("NONTOPHIfullcohort", Pval),
                clean_lapply("suTOPHIfullcohort", Pval),
                clean_lapply("suNONTOPHIfullcohort", Pval),
                clean_lapply("FLAREHIGHfullcohort", Pval),
                clean_lapply("FLARELOWfullcohort", Pval),
                clean_lapply("suFLAREHIGHfullcohort", Pval),
                clean_lapply("suFLARELOWfullcohort", Pval))

CollidervsPRS <- tibble("Outcome" = OutcomeString,
                        "Predictor" = PredictorString,
                        "Covariates" = CovariateString, 
                        "Cohort" = CohortString, 
                        "OR" = ORString, 
                        "95% CI" = CIString, 
                        "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))
save(CollidervsPRS, file = here("Output/CollidervsPRS.RData"))

remove <- ls()
remove <- as.tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as.tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x, fullcohort)


# Now for Polynesians
tmp <- eastpoly_control %>% 
  mutate(FLAREHIGH = FALSE,
         TOPHIGOUT = FALSE,
         FLARELOW = FALSE,
         NONTOPHIGOUT = FALSE)

tmp2 <- eastpoly_gout %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT)

eastpoly_full2 <- full_join(tmp2, tmp) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

tmp <- westpoly_control %>% 
  mutate(FLAREHIGH = FALSE,
         TOPHIGOUT = FALSE,
         FLARELOW = FALSE,
         NONTOPHIGOUT = FALSE)

tmp2 <- westpoly_gout %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT)

westpoly_full2 <- full_join(tmp2, tmp) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(tmp, tmp2)



# Running the models
logistic_model_poly(eastpoly_full2, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIeast")

logistic_model_poly(westpoly_full2, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIwest")


logistic_model_poly(eastpoly_full2, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIeast")

logistic_model_poly(westpoly_full2, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIwest")


logistic_model_poly(eastpoly_full2, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIeast")

logistic_model_poly(westpoly_full2, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIwest")


logistic_model_poly(eastpoly_full2, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIeast")

logistic_model_poly(westpoly_full2, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIwest")


logistic_model_poly(eastpoly_full2, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHeast")

logistic_model_poly(westpoly_full2, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHwest")


logistic_model_poly(eastpoly_full2, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWeast")

logistic_model_poly(westpoly_full2, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWwest")


logistic_model_poly(eastpoly_full2, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHeast")

logistic_model_poly(westpoly_full2, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHwest")


logistic_model_poly(eastpoly_full2, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWeast")

logistic_model_poly(westpoly_full2, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWwest")



# Creating table of results
grsnames <- colnames(select(eastpoly_full2, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)



OutcomeString <- c(rep("Tophaceous gout", 2*x),
                   rep("Non-tophaceous gout", 2*x),
                   rep("Tophaceous gout", 2*x),
                   rep("Non-tophaceous gout", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Low activity gout (< 2 flares/year)", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Low activity gout (< 2 flares/year)", 2*x))

PredictorString <- rep(grsnames, 16)

CovariateString <- c(rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x))

CohortString <- c(rep(c(rep("East Polynesians", x),
                        rep("West Polynesians", x)), 8))

ORString <- c(clean_lapply("TOPHIeast", OR),
              clean_lapply("TOPHIwest", OR),
              clean_lapply("NONTOPHIeast", OR),
              clean_lapply("NONTOPHIwest", OR),
              clean_lapply("suTOPHIeast", OR),
              clean_lapply("suTOPHIwest", OR),
              clean_lapply("suNONTOPHIeast", OR),
              clean_lapply("suNONTOPHIwest", OR),
              clean_lapply("FLAREHIGHeast", OR),
              clean_lapply("FLAREHIGHwest", OR),
              clean_lapply("FLARELOWeast", OR),
              clean_lapply("FLARELOWwest", OR),
              clean_lapply("suFLAREHIGHeast", OR),
              clean_lapply("suFLAREHIGHwest", OR),
              clean_lapply("suFLARELOWeast", OR),
              clean_lapply("suFLARELOWwest", OR))

CIString <- c(clean_lapply("TOPHIeast", CI_OR),
              clean_lapply("TOPHIwest", CI_OR),
              clean_lapply("NONTOPHIeast", CI_OR),
              clean_lapply("NONTOPHIwest", CI_OR),
              clean_lapply("suTOPHIeast", CI_OR),
              clean_lapply("suTOPHIwest", CI_OR),
              clean_lapply("suNONTOPHIeast", CI_OR),
              clean_lapply("suNONTOPHIwest", CI_OR),
              clean_lapply("FLAREHIGHeast", CI_OR),
              clean_lapply("FLAREHIGHwest", CI_OR),
              clean_lapply("FLARELOWeast", CI_OR),
              clean_lapply("FLARELOWwest", CI_OR),
              clean_lapply("suFLAREHIGHeast", CI_OR),
              clean_lapply("suFLAREHIGHwest", CI_OR),
              clean_lapply("suFLARELOWeast", CI_OR),
              clean_lapply("suFLARELOWwest", CI_OR))

PvalString <- c(clean_lapply("TOPHIeast", Pval),
                clean_lapply("TOPHIwest", Pval),
                clean_lapply("NONTOPHIeast", Pval),
                clean_lapply("NONTOPHIwest", Pval),
                clean_lapply("suTOPHIeast", Pval),
                clean_lapply("suTOPHIwest", Pval),
                clean_lapply("suNONTOPHIeast", Pval),
                clean_lapply("suNONTOPHIwest", Pval),
                clean_lapply("FLAREHIGHeast", Pval),
                clean_lapply("FLAREHIGHwest", Pval),
                clean_lapply("FLARELOWeast", Pval),
                clean_lapply("FLARELOWwest", Pval),
                clean_lapply("suFLAREHIGHeast", Pval),
                clean_lapply("suFLAREHIGHwest", Pval),
                clean_lapply("suFLARELOWeast", Pval),
                clean_lapply("suFLARELOWwest", Pval))

CollidervsPRS_Poly <- tibble("Outcome" = OutcomeString,
                             "Predictor" = PredictorString,
                             "Covariates" = CovariateString, 
                             "Cohort" = CohortString, 
                             "OR" = ORString, 
                             "95% CI" = CIString, 
                             "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))
save(CollidervsPRS_Poly, file = here("Output/CollidervsPRS_Poly.RData"))

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x, eastpoly_full2, westpoly_full2)
```

```{r Relationships, echo = FALSE}
# Now I want to determine the relationship between the three severity traits themselves alongside age and sex
# I will do this for each cohort independently
# First testing how sex and age affect each trait (which I kind of already tested in the models)
tmp1 <- lm(AGE1ATK ~ SEX, data = anz_gout)
tmp2 <- lm(AGE1ATK ~ SEX, data = eurogout)
tmp3 <- lm(AGE1ATK ~ SEX, data = ardea_clear_lasso)
tmp4 <- lm(AGE1ATK ~ SEX, data = ardea_lasso_other)
tmp5 <- lm(AGE1ATK ~ SEX, data = ardea_crystal)
tmp6 <- lm(AGE1ATK ~ SEX, data = ardea_light)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]], tmp6$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2], summary(tmp6)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout", "Ardea - CLEAR + LASSO", "Ardea - LASSO (other)", "Ardea - CRYSTAL", "Ardea - LIGHT"))
summary(mod)
mod$pval.fixed # Females have around 13 years later age at onset on average (p = 7.6e-63)

# No need to test age vs age at onset (obviously correlated)


# Flare activity vs sex
tmp1 <- glm(FLAREHIGH ~ SEX, family = "binomial", data = anz_gout)
tmp2 <- glm(FLAREHIGH ~ SEX, family = "binomial", data = eurogout)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout"), sm = "OR")
summary(mod)
mod$pval.fixed # Non-significant reduced flare activity in females (p = 0.99)

# Flare activity vs age
tmp1 <- glm(FLAREHIGH ~ AGECOL, family = "binomial", data = anz_gout)
tmp2 <- glm(FLAREHIGH ~ AGECOL, family = "binomial", data = eurogout)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout"), sm = "OR")
summary(mod)
mod$pval.fixed # Reduced flare activity in older people (OR of 0.98 per year older, p = 7.0e-9)


# Tophi vs sex
tmp1 <- glm(TOPHIGOUT ~ SEX, family = "binomial", data = anz_gout)
tmp2 <- glm(TOPHIGOUT ~ SEX, family = "binomial", data = eurogout)
tmp3 <- glm(TOPHIGOUT ~ SEX, family = "binomial", data = ardea_clear_lasso)
tmp4 <- glm(TOPHIGOUT ~ SEX, family = "binomial", data = ardea_lasso_other)
tmp5 <- glm(TOPHIGOUT ~ SEX, family = "binomial", data = ardea_light)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout", "Ardea - CLEAR + LASSO", "Ardea - LASSO (other)", "Ardea - LIGHT"), sm = "OR")
summary(mod)
mod$pval.fixed # Non-significant reduction in tophi presence in females (p = 0.66)

# Tophi vs age
tmp1 <- glm(TOPHIGOUT ~ AGECOL, family = "binomial", data = anz_gout)
tmp2 <- glm(TOPHIGOUT ~ AGECOL, family = "binomial", data = eurogout)
tmp3 <- glm(TOPHIGOUT ~ AGECOL, family = "binomial", data = ardea_clear_lasso)
tmp4 <- glm(TOPHIGOUT ~ AGECOL, family = "binomial", data = ardea_lasso_other)
tmp5 <- glm(TOPHIGOUT ~ AGECOL, family = "binomial", data = ardea_light)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout", "Ardea - CLEAR + LASSO", "Ardea - LASSO (other)", "Ardea - LIGHT"), sm = "OR")
summary(mod) 
mod$pval.fixed # More tophi presence in older individuals (due to duration increase, OR 1.01, p = 1.5e-5)


# Now to test relationship between severity traits
# Flare activity vs age at onset
tmp1 <- glm(FLAREHIGH ~ AGE1ATK, family = "binomial", data = anz_gout)
tmp2 <- glm(FLAREHIGH ~ AGE1ATK, family = "binomial", data = eurogout)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout"), sm = "OR")
summary(mod)
mod$pval.fixed # Non-significant decrease in flare activity per year later age at onset (p = 0.10)

# Tophi positivity vs age at onset
tmp1 <- glm(TOPHIGOUT ~ AGE1ATK, family = "binomial", data = anz_gout)
tmp2 <- glm(TOPHIGOUT ~ AGE1ATK, family = "binomial", data = eurogout)
tmp3 <- glm(TOPHIGOUT ~ AGE1ATK, family = "binomial", data = ardea_clear_lasso)
tmp4 <- glm(TOPHIGOUT ~ AGE1ATK, family = "binomial", data = ardea_lasso_other)
tmp5 <- glm(TOPHIGOUT ~ AGE1ATK, family = "binomial", data = ardea_light)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]], tmp3$coefficients[[2]], tmp4$coefficients[[2]], tmp5$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2], summary(tmp3)$coefficients[2,2], summary(tmp4)$coefficients[2,2], summary(tmp5)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout", "Ardea - CLEAR + LASSO", "Ardea - LASSO (other)", "Ardea - LIGHT"), sm = "OR")
summary(mod) 
mod$pval.fixed # Decrease in tophus positivity per year later age at onset (OR = 0.99, p = 0.003)

# Flare activity vs tophi
tmp1 <- glm(FLAREHIGH ~ TOPHIGOUT, family = "binomial", data = anz_gout)
tmp2 <- glm(FLAREHIGH ~ TOPHIGOUT, family = "binomial", data = eurogout)

mod <- metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "GlobalGout"), sm = "OR")
summary(mod)
mod$pval.fixed # Flare activity significantly increases with presence of tophi (OR = 1.81, p = 7.4e-9)


# Cleaning up
rm(tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, mod)
```

```{r LessULTGoutModels, echo = FALSE}
# Creating LessULT cohorts
# To do this, I will only include people that are definitely not on ULT (i.e. remove those TRUE or NA)
# This will exclude all of Ardea (even though some weren't on ULT they were listed as NA for ULT)
anz_gout_noULT <- anz_gout %>% 
  filter(ULT == FALSE)

anz_full_noULT <- full_join(anz_gout_noULT, anz_control)

eurogout_noULT <- eurogout %>% 
  filter(ULT == FALSE)

ukbb_gout_noULT <- ukbb_gout %>% 
  filter(ULT == FALSE)

ukbb_noULT <- full_join(ukbb_gout_noULT, ukbb_control)

allgout_noULT <- allgout %>% 
  filter(ULT == FALSE)

eastpoly_gout_noULT <- eastpoly_gout %>% 
  filter(ULT == FALSE)

eastpoly_full_noULT <- full_join(eastpoly_gout_noULT, eastpoly_control)

westpoly_gout_noULT <- westpoly_gout %>% 
  filter(ULT == FALSE)

westpoly_full_noULT <- full_join(westpoly_gout_noULT, westpoly_control)


# Modeling Gout + Serum urate vs PRS in Aus/NZ Europeans and UK Biobank
# Also modelling Gout adjusted for SU and SU in gout cohorts
logistic_model(anz_full_noULT, "GOUT", c("SEX", "AGECOL"), "GOUTanz")

logistic_model_ukbb(ukbb_noULT, "GOUT", c("SEX", "AGECOL"), "GOUTukbb")


logistic_model(anz_full_noULT, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTanz")

logistic_model_ukbb(ukbb_noULT, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTukbb")


linear_model(anz_full_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEanz")

linear_model_ukbb(ukbb_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEukbb")


linear_model(anz_gout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEanz_gout")

linear_model_ukbb(ukbb_gout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEukbb_gout")


linear_model(anz_control, "SURICACID", c("SEX", "AGECOL"), "URATEanz_control")

linear_model_ukbb(ukbb_control, "SURICACID", c("SEX", "AGECOL"), "URATEukbb_control")


linear_model(eurogout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEeurogout")

linear_model(allgout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEallgout")


# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Gout", 4*x),
                   rep("Serum urate", 8*x))

PredictorString <- rep(grsnames, 12)

CovariateString <- c(rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Age + 10 PCs", 8*x))

CohortString <- c(rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ", x),
                  rep("UK Biobank", x),
                  rep("Aus/NZ - gout", x),
                  rep("UK Biobank - gout", x),
                  rep("Aus/NZ - control", x),
                  rep("UK Biobank - control", x),
                  rep("GlobalGout", x),
                  rep("Pooled European Gout (no UKBB)", x))

ORString <- c(clean_lapply("GOUTanz", OR),
              clean_lapply("GOUTukbb", OR),
              clean_lapply("suGOUTanz", OR),
              clean_lapply("suGOUTukbb", OR),
              rep(NAString, 8))

BetaString <- c(rep(NAString, 4),
                clean_lapply("URATEanz", Print_beta),
                clean_lapply("URATEukbb", Print_beta),
                clean_lapply("URATEanz_gout", Print_beta),
                clean_lapply("URATEukbb_gout", Print_beta),
                clean_lapply("URATEanz_control", Print_beta),
                clean_lapply("URATEukbb_control", Print_beta),
                clean_lapply("URATEeurogout", Print_beta),
                clean_lapply("URATEallgout", Print_beta))

CIString <- c(clean_lapply("GOUTanz", CI_OR),
              clean_lapply("GOUTukbb", CI_OR),
              clean_lapply("suGOUTanz", CI_OR),
              clean_lapply("suGOUTukbb", CI_OR),
              clean_lapply("URATEanz", CI_beta),
              clean_lapply("URATEukbb", CI_beta),
              clean_lapply("URATEanz_gout", CI_beta),
              clean_lapply("URATEukbb_gout", CI_beta),
              clean_lapply("URATEanz_control", CI_beta),
              clean_lapply("URATEukbb_control", CI_beta),
              clean_lapply("URATEeurogout", CI_beta),
              clean_lapply("URATEallgout", CI_beta))

PvalString <- c(clean_lapply("GOUTanz", Pval),
                clean_lapply("GOUTukbb", Pval),
                clean_lapply("suGOUTanz", Pval),
                clean_lapply("suGOUTukbb", Pval),
                clean_lapply("URATEanz", Pval),
                clean_lapply("URATEukbb", Pval),
                clean_lapply("URATEanz_gout", Pval),
                clean_lapply("URATEukbb_gout", Pval),
                clean_lapply("URATEanz_control", Pval),
                clean_lapply("URATEukbb_control", Pval),
                clean_lapply("URATEeurogout", Pval),
                clean_lapply("URATEallgout", Pval))

GoutvsPRS_noULT <- tibble("Outcome" = OutcomeString,
                    "Predictor" = PredictorString,
                    "Covariates" = CovariateString, 
                    "Cohort" = CohortString, 
                    "OR" = ORString, 
                    "Beta" = BetaString, 
                    "95% CI" = CIString, 
                    "Pval" = PvalString)
GoutvsPRS_noULT <- GoutvsPRS_noULT %>% mutate("Signif." = case_when(Pval < 2.38e-3 ~ "**", Pval >= 2.38e-3 & Pval < 0.05 ~ "*", TRUE ~ "-"))
save(GoutvsPRS_noULT, file = "RData/GoutvsPRS_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)


# Modeling Gout + Serum urate vs PRS in East and West Polynesians
# Also modelling Gout adjusted for SU and SU in gout cohorts
logistic_model_poly(eastpoly_full_noULT, "GOUT", c("SEX", "AGECOL"), "GOUTeast")

logistic_model_poly(westpoly_full_noULT, "GOUT", c("SEX", "AGECOL"), "GOUTwest")


logistic_model_poly(eastpoly_full_noULT, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTeast")

logistic_model_poly(westpoly_full_noULT, "GOUT", c("SEX", "AGECOL", "SURICACID"), "suGOUTwest")


linear_model_poly(eastpoly_full_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEeast")

linear_model_poly(westpoly_full_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEwest")


linear_model_poly(eastpoly_gout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEeast_gout")

linear_model_poly(westpoly_gout_noULT, "SURICACID", c("SEX", "AGECOL"), "URATEwest_gout")


linear_model_poly(eastpoly_control, "SURICACID", c("SEX", "AGECOL"), "URATEeast_control")

linear_model_poly(westpoly_control, "SURICACID", c("SEX", "AGECOL"), "URATEwest_control")


# Creating table of results
grsnames <- colnames(select(eastpoly_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Gout", 4*x),
                   rep("Serum urate", 6*x))

PredictorString <- rep(grsnames, 10)

CovariateString <- c(rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 6*x))

CohortString <- c(rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian", x),
                  rep("West Polynesian", x),
                  rep("East Polynesian - gout", x),
                  rep("West Polynesian - gout", x),
                  rep("East Polynesian - control", x),
                  rep("West Polynesian - control", x))

ORString <- c(clean_lapply("GOUTeast", OR),
              clean_lapply("GOUTwest", OR),
              clean_lapply("suGOUTeast", OR),
              clean_lapply("suGOUTwest", OR),
              rep(NAString, 6))

BetaString <- c(rep(NAString, 4),
                clean_lapply("URATEeast", Print_beta),
                clean_lapply("URATEwest", Print_beta),
                clean_lapply("URATEeast_gout", Print_beta),
                clean_lapply("URATEwest_gout", Print_beta),
                clean_lapply("URATEeast_control", Print_beta),
                clean_lapply("URATEwest_control", Print_beta))

CIString <- c(clean_lapply("GOUTeast", CI_OR),
              clean_lapply("GOUTwest", CI_OR),
              clean_lapply("suGOUTeast", CI_OR),
              clean_lapply("suGOUTwest", CI_OR),
              clean_lapply("URATEeast", CI_beta),
              clean_lapply("URATEwest", CI_beta),
              clean_lapply("URATEeast_gout", CI_beta),
              clean_lapply("URATEwest_gout", CI_beta),
              clean_lapply("URATEeast_control", CI_beta),
              clean_lapply("URATEwest_control", CI_beta))

PvalString <- c(clean_lapply("GOUTeast", Pval),
                clean_lapply("GOUTwest", Pval),
                clean_lapply("suGOUTeast", Pval),
                clean_lapply("suGOUTwest", Pval),
                clean_lapply("URATEeast", Pval),
                clean_lapply("URATEwest", Pval),
                clean_lapply("URATEeast_gout", Pval),
                clean_lapply("URATEwest_gout", Pval),
                clean_lapply("URATEeast_control", Pval),
                clean_lapply("URATEwest_control", Pval))

GoutvsPRS_Poly_noULT <- tibble("Outcome" = OutcomeString,
                        "Predictor" = PredictorString,
                        "Covariates" = CovariateString, 
                        "Cohort" = CohortString, 
                        "OR" = ORString, 
                        "Beta" = BetaString, 
                        "95% CI" = CIString, 
                        "Pval" = PvalString)
GoutvsPRS_Poly_noULT <- GoutvsPRS_Poly_noULT %>% mutate("Signif." = case_when(Pval < 2.38e-3 ~ "**", Pval >= 2.38e-3 & Pval < 0.05 ~ "*", TRUE ~ "-"))
save(GoutvsPRS_Poly_noULT, file = "RData/GoutvsPRS_Poly_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)
```

```{r LessULTSeverityModels, echo = FALSE}
linear_meta_noULT <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- lm(f, data = anz_gout_noULT)
    tmp2 <- lm(f, data = eurogout_noULT)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout"))))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

logistic_meta_noULT <- function(outcome, covariates, modelname) {
  grsnames <- colnames(select(anz_gout, PRS:PRS_std))
  x <- length(grsnames)
  tmplist <- list()
  for(i in 1:x) {
    variables <- c(grsnames[i], covariates, "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")
    f <- as.formula(paste(outcome, paste(variables, collapse = " + "), sep = " ~ "))
    tmp1 <- glm(f, family = "binomial", data = anz_gout_noULT)
    tmp2 <- glm(f, family = "binomial", data = eurogout_noULT)
    assign(paste0(modelname, i), (metagen(TE = c(tmp1$coefficients[[2]], tmp2$coefficients[[2]]), seTE = c(summary(tmp1)$coefficients[2,2], summary(tmp2)$coefficients[2,2]), studlab = c("Aus/NZ", "EuroGout"), sm = "OR")))
    tmplist[[i]] <- get(paste0(modelname, i))
  }
  assign(paste0(modelname, "modlist"), tmplist, envir = .GlobalEnv)
}

# European Meta-analyses
linear_meta_noULT("AGE1ATK", c("SEX"), "metaONSET")

linear_meta_noULT("AGE1ATK", c("SEX", "SURICACID"), "sumetaONSET")

logistic_meta_noULT("TOPHIGOUT", c("SEX", "AGECOL"), "metaTOPHI")

logistic_meta_noULT("TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "sumetaTOPHI")

logistic_meta_noULT("TOPHIGOUT", c("SEX", "DURATION"), "durmetaTOPHI")

logistic_meta_noULT("FLAREHIGH", c("SEX", "AGECOL"), "metaFLARE")

logistic_meta_noULT("FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "sumetaFLARE")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)



OutcomeString <- c(rep("Age at onset (years)", 2*x),
                   rep("Presence of tophi", 3*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x))

PredictorString <- rep(grsnames, 7)

CovariateString <- c(rep("Sex + 10 PCs", x),
                     rep("Sex + Serum urate + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", x),
                     rep("Sex + Age + Serum urate + 10 PCs", x),
                     rep("Sex + Disease duration + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", x),
                     rep("Sex + Age + Serum urate + 10 PCs", x))

CohortString <- c(rep("European Gout (Meta-analysis)", 7*x))

ORString <- c(rep(NAString, 2),
              clean_lapply("metaTOPHI", OR_meta),
              clean_lapply("sumetaTOPHI", OR_meta),
              clean_lapply("durmetaTOPHI", OR_meta),
              clean_lapply("metaFLARE", OR_meta),
              clean_lapply("sumetaFLARE", OR_meta))

BetaString <- c(clean_lapply("metaONSET", Print_beta_meta),
                clean_lapply("sumetaONSET", Print_beta_meta),
                rep(NAString, 5))

CIString <- c(clean_lapply("metaONSET", CI_beta_meta),
              clean_lapply("sumetaONSET", CI_beta_meta),
              clean_lapply("metaTOPHI", CI_OR_meta),
              clean_lapply("sumetaTOPHI", CI_OR_meta),
              clean_lapply("durmetaTOPHI", CI_OR_meta),
              clean_lapply("metaFLARE", CI_OR_meta),
              clean_lapply("sumetaFLARE", CI_OR_meta))

PvalString <- c(clean_lapply("metaONSET", Pval_meta),
                clean_lapply("sumetaONSET", Pval_meta),
                clean_lapply("metaTOPHI", Pval_meta),
                clean_lapply("sumetaTOPHI", Pval_meta),
                clean_lapply("durmetaTOPHI", Pval_meta),
                clean_lapply("metaFLARE", Pval_meta),
                clean_lapply("sumetaFLARE", Pval_meta))

Meta3traitsvsPRS_noULT <- tibble("Outcome" = OutcomeString,
                           "Predictor" = PredictorString,
                           "Covariates" = CovariateString, 
                           "Cohort" = CohortString, 
                           "OR" = ORString, 
                           "Beta" = BetaString, 
                           "95% CI" = CIString, 
                           "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))

save(Meta3traitsvsPRS_noULT, file = "RData/Meta3traitsvsPRS_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)



# Now for European pooled analyses
linear_model(allgout_noULT, "AGE1ATK", c("SEX"), "ONSETallgout")


linear_model(allgout_noULT, "AGE1ATK", c("SEX", "SURICACID"), "suONSETallgout")


logistic_model(allgout_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIallgout")


logistic_model(allgout_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREallgout")


logistic_model(allgout_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIallgout")


logistic_model(allgout_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREallgout")


logistic_model(allgout_noULT, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIallgout")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Age at onset (years)", 2*x),
                   rep("Presence of tophi", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Presence of tophi", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Presence of tophi", x))

PredictorString <- rep(grsnames, 7)

CovariateString <- c(rep("Sex + 10 PCs", x),
                     rep("Sex + Serum urate + 10 PCs", x),
                     rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Disease duration + 10 PCs", x))

CohortString <- rep("Pooled Europeans", 7*x)

ORString <- c(rep(NAString, 2),
              clean_lapply("TOPHIallgout", OR),
              clean_lapply("FLAREallgout", OR),
              clean_lapply("suTOPHIallgout", OR),
              clean_lapply("suFLAREallgout", OR),
              clean_lapply("durTOPHIallgout", OR))

BetaString <- c(clean_lapply("ONSETallgout", Print_beta),
                clean_lapply("suONSETallgout", Print_beta),
                rep(NAString, 5))

CIString <- c(clean_lapply("ONSETallgout", CI_beta),
              clean_lapply("suONSETallgout", CI_beta),
              clean_lapply("TOPHIallgout", CI_OR),
              clean_lapply("FLAREallgout", CI_OR),
              clean_lapply("suTOPHIallgout", CI_OR),
              clean_lapply("suFLAREallgout", CI_OR),
              clean_lapply("durTOPHIallgout", CI_OR))

PvalString <- c(clean_lapply("ONSETallgout", Pval),
                clean_lapply("suONSETallgout", Pval),
                clean_lapply("TOPHIallgout", Pval),
                clean_lapply("FLAREallgout", Pval),
                clean_lapply("suTOPHIallgout", Pval),
                clean_lapply("suFLAREallgout", Pval),
                clean_lapply("durTOPHIallgout", Pval))

PooledvsPRS_noULT <- tibble("Outcome" = OutcomeString,
                      "Predictor" = PredictorString,
                      "Covariates" = CovariateString, 
                      "Cohort" = CohortString, 
                      "OR" = ORString, 
                      "Beta" = BetaString, 
                      "95% CI" = CIString, 
                      "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))

save(PooledvsPRS_noULT, file = "RData/PooledvsPRS_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)


# Now for Polynesian pooled analyses
linear_model_poly(eastpoly_gout_noULT, "AGE1ATK", c("SEX"), "ONSETeast")

linear_model_poly(westpoly_gout_noULT, "AGE1ATK", c("SEX"), "ONSETwest")

linear_model_poly(eastpoly_gout_noULT, "AGE1ATK", c("SEX", "SURICACID"), "suONSETeast")

linear_model_poly(westpoly_gout_noULT, "AGE1ATK", c("SEX", "SURICACID"), "suONSETwest")

logistic_model_poly(eastpoly_gout_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIeast")

logistic_model_poly(westpoly_gout_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIwest")

logistic_model_poly(eastpoly_gout_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREeast")

logistic_model_poly(westpoly_gout_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREwest")

logistic_model_poly(eastpoly_gout_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIeast")

logistic_model_poly(westpoly_gout_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIwest")

logistic_model_poly(eastpoly_gout_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREeast")

logistic_model_poly(westpoly_gout_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREwest")

logistic_model_poly(eastpoly_gout_noULT, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIeast")

logistic_model_poly(westpoly_gout_noULT, "TOPHIGOUT", c("SEX", "DURATION"), "durTOPHIwest")


# Creating table of results
grsnames <- colnames(select(eastpoly_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Age at onset (years)", 4*x),
                   rep("Presence of tophi", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Presence of tophi", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Presence of tophi", 2*x))

PredictorString <- rep(grsnames, 14)

CovariateString <- c(rep("Sex + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Serum urate + 10 Global PCs + 10 Oceanian PCs", 2*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Disease duration + 10 Global PCs + 10 Oceanian PCs", 2*x))

CohortString <- rep(c(rep("East Polynesian gout", x), 
                      rep("West Polynesian gout", x)), 7)

ORString <- c(rep(NAString, 4),
              clean_lapply("TOPHIeast", OR),
              clean_lapply("TOPHIwest", OR),
              clean_lapply("FLAREeast", OR),
              clean_lapply("FLAREwest", OR),
              clean_lapply("suTOPHIeast", OR),
              clean_lapply("suTOPHIwest", OR),
              clean_lapply("suFLAREeast", OR),
              clean_lapply("suFLAREwest", OR),
              clean_lapply("durTOPHIeast", OR),
              clean_lapply("durTOPHIwest", OR))

BetaString <- c(clean_lapply("ONSETeast", Print_beta),
                clean_lapply("ONSETwest", Print_beta),
                clean_lapply("suONSETeast", Print_beta),
                clean_lapply("suONSETwest", Print_beta),
                rep(NAString, 10))

CIString <- c(clean_lapply("ONSETeast", CI_beta),
              clean_lapply("ONSETwest", CI_beta),
              clean_lapply("suONSETeast", CI_beta),
              clean_lapply("suONSETwest", CI_beta),
              clean_lapply("TOPHIeast", CI_OR),
              clean_lapply("TOPHIwest", CI_OR),
              clean_lapply("FLAREeast", CI_OR),
              clean_lapply("FLAREwest", CI_OR),
              clean_lapply("suTOPHIeast", CI_OR),
              clean_lapply("suTOPHIwest", CI_OR),
              clean_lapply("suFLAREeast", CI_OR),
              clean_lapply("suFLAREwest", CI_OR),
              clean_lapply("durTOPHIeast", CI_OR),
              clean_lapply("durTOPHIwest", CI_OR))

PvalString <- c(clean_lapply("ONSETeast", Pval),
                clean_lapply("ONSETwest", Pval),
                clean_lapply("suONSETeast", Pval),
                clean_lapply("suONSETwest", Pval),
                clean_lapply("TOPHIeast", Pval),
                clean_lapply("TOPHIwest", Pval),
                clean_lapply("FLAREeast", Pval),
                clean_lapply("FLAREwest", Pval),
                clean_lapply("suTOPHIeast", Pval),
                clean_lapply("suTOPHIwest", Pval),
                clean_lapply("suFLAREeast", Pval),
                clean_lapply("suFLAREwest", Pval),
                clean_lapply("durTOPHIeast", Pval),
                clean_lapply("durTOPHIwest", Pval))

PooledvsPRS_Poly_noULT <- tibble("Outcome" = OutcomeString,
                           "Predictor" = PredictorString,
                           "Covariates" = CovariateString, 
                           "Cohort" = CohortString, 
                           "OR" = ORString, 
                           "Beta" = BetaString, 
                           "95% CI" = CIString, 
                           "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                                     Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                                     TRUE ~ "-"))

save(PooledvsPRS_Poly_noULT, file = "RData/PooledvsPRS_Poly_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x)
```

```{r LessULTColliderModels, echo = FALSE}
# Tony suggested we could do a pooled analysis with UK Biobank controls to account for collider bias
# Preparing the cohorts
tmp <- ukbb_control %>% 
  mutate(FLAREHIGH = rep(FALSE, nrow(.)),
         TOPHIGOUT = rep(FALSE, nrow(.)),
         FLARELOW = rep(FALSE, nrow(.)),
         NONTOPHIGOUT = rep(FALSE, nrow(.)))

tmp2 <- allgout_noULT %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT) %>% 
  select(-COHORT2)

fullcohort_noULT <- rbind(tmp, tmp2) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(tmp, tmp2)



# Running the models
logistic_model_ukbb(fullcohort_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIfullcohort")


logistic_model_ukbb(fullcohort_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIfullcohort")


logistic_model_ukbb(fullcohort_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIfullcohort")


logistic_model_ukbb(fullcohort_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIfullcohort")


logistic_model_ukbb(fullcohort_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHfullcohort")


logistic_model_ukbb(fullcohort_noULT, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWfullcohort")


logistic_model_ukbb(fullcohort_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHfullcohort")


logistic_model_ukbb(fullcohort_noULT, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWfullcohort")



# Creating table of results
grsnames <- colnames(select(anz_gout, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)

OutcomeString <- c(rep("Tophaceous gout", x),
                   rep("Non-tophaceous gout", x),
                   rep("Tophaceous gout", x),
                   rep("Non-tophaceous gout", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Low activity gout (< 2 flares/year)", x),
                   rep("Active gout (≥ 2 flares/year)", x),
                   rep("Low activity gout (< 2 flares/year)", x))

PredictorString <- rep(grsnames, 8)

CovariateString <- c(rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x),
                     rep("Sex + Age + 10 PCs", 2*x),
                     rep("Sex + Age + Serum urate + 10 PCs", 2*x))

CohortString <- rep("Pooled European Gout (no UKBB) + UKBB Controls", 8*x)

ORString <- c(clean_lapply("TOPHIfullcohort", OR),
              clean_lapply("NONTOPHIfullcohort", OR),
              clean_lapply("suTOPHIfullcohort", OR),
              clean_lapply("suNONTOPHIfullcohort", OR),
              clean_lapply("FLAREHIGHfullcohort", OR),
              clean_lapply("FLARELOWfullcohort", OR),
              clean_lapply("suFLAREHIGHfullcohort", OR),
              clean_lapply("suFLARELOWfullcohort", OR))

CIString <- c(clean_lapply("TOPHIfullcohort", CI_OR),
              clean_lapply("NONTOPHIfullcohort", CI_OR),
              clean_lapply("suTOPHIfullcohort", CI_OR),
              clean_lapply("suNONTOPHIfullcohort", CI_OR),
              clean_lapply("FLAREHIGHfullcohort", CI_OR),
              clean_lapply("FLARELOWfullcohort", CI_OR),
              clean_lapply("suFLAREHIGHfullcohort", CI_OR),
              clean_lapply("suFLARELOWfullcohort", CI_OR))

PvalString <- c(clean_lapply("TOPHIfullcohort", Pval),
                clean_lapply("NONTOPHIfullcohort", Pval),
                clean_lapply("suTOPHIfullcohort", Pval),
                clean_lapply("suNONTOPHIfullcohort", Pval),
                clean_lapply("FLAREHIGHfullcohort", Pval),
                clean_lapply("FLARELOWfullcohort", Pval),
                clean_lapply("suFLAREHIGHfullcohort", Pval),
                clean_lapply("suFLARELOWfullcohort", Pval))

CollidervsPRS_noULT <- tibble("Outcome" = OutcomeString,
                        "Predictor" = PredictorString,
                        "Covariates" = CovariateString, 
                        "Cohort" = CohortString, 
                        "OR" = ORString, 
                        "95% CI" = CIString, 
                        "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))
save(CollidervsPRS_noULT, file = "RData/CollidervsPRS_noULT.RData")

remove <- ls()
remove <- as.tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as.tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x, fullcohort)


# Now for Polynesians
tmp <- eastpoly_control %>% 
  mutate(FLAREHIGH = rep(FALSE, nrow(.)),
         TOPHIGOUT = rep(FALSE, nrow(.)),
         FLARELOW = rep(FALSE, nrow(.)),
         NONTOPHIGOUT = rep(FALSE, nrow(.)))

tmp2 <- eastpoly_gout_noULT %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT)

eastpoly_full2_noULT <- full_join(tmp2, tmp) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

tmp <- westpoly_control %>% 
  mutate(FLAREHIGH = rep(FALSE, nrow(.)),
         TOPHIGOUT = rep(FALSE, nrow(.)),
         FLARELOW = rep(FALSE, nrow(.)),
         NONTOPHIGOUT = rep(FALSE, nrow(.)))

tmp2 <- westpoly_gout_noULT %>% 
  mutate(FLARELOW = !FLAREHIGH,
         NONTOPHIGOUT = !TOPHIGOUT)

westpoly_full2_noULT <- full_join(tmp2, tmp) %>% 
  mutate(PRS_std = (PRS - mean(PRS)) / sd(PRS))

rm(tmp, tmp2)



# Running the models
logistic_model_poly(eastpoly_full2_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIeast")

logistic_model_poly(westpoly_full2_noULT, "TOPHIGOUT", c("SEX", "AGECOL"), "TOPHIwest")


logistic_model_poly(eastpoly_full2_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIeast")

logistic_model_poly(westpoly_full2_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL"), "NONTOPHIwest")


logistic_model_poly(eastpoly_full2_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIeast")

logistic_model_poly(westpoly_full2_noULT, "TOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suTOPHIwest")


logistic_model_poly(eastpoly_full2_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIeast")

logistic_model_poly(westpoly_full2_noULT, "NONTOPHIGOUT", c("SEX", "AGECOL", "SURICACID"), "suNONTOPHIwest")


logistic_model_poly(eastpoly_full2_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHeast")

logistic_model_poly(westpoly_full2_noULT, "FLAREHIGH", c("SEX", "AGECOL"), "FLAREHIGHwest")


logistic_model_poly(eastpoly_full2_noULT, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWeast")

logistic_model_poly(westpoly_full2_noULT, "FLARELOW", c("SEX", "AGECOL"), "FLARELOWwest")


logistic_model_poly(eastpoly_full2_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHeast")

logistic_model_poly(westpoly_full2_noULT, "FLAREHIGH", c("SEX", "AGECOL", "SURICACID"), "suFLAREHIGHwest")


logistic_model_poly(eastpoly_full2_noULT, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWeast")

logistic_model_poly(westpoly_full2_noULT, "FLARELOW", c("SEX", "AGECOL", "SURICACID"), "suFLARELOWwest")



# Creating table of results
grsnames <- colnames(select(eastpoly_full2_noULT, PRS:PRS_std))

x <- length(grsnames)

NAString <- rep(NA, x)



OutcomeString <- c(rep("Tophaceous gout", 2*x),
                   rep("Non-tophaceous gout", 2*x),
                   rep("Tophaceous gout", 2*x),
                   rep("Non-tophaceous gout", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Low activity gout (< 2 flares/year)", 2*x),
                   rep("Active gout (≥ 2 flares/year)", 2*x),
                   rep("Low activity gout (< 2 flares/year)", 2*x))

PredictorString <- rep(grsnames, 16)

CovariateString <- c(rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + 10 Global PCs + 10 Oceanian PCs", 4*x),
                     rep("Sex + Age + Serum urate + 10 Global PCs + 10 Oceanian PCs", 4*x))

CohortString <- c(rep(c(rep("East Polynesians", x),
                        rep("West Polynesians", x)), 8))

ORString <- c(clean_lapply("TOPHIeast", OR),
              clean_lapply("TOPHIwest", OR),
              clean_lapply("NONTOPHIeast", OR),
              clean_lapply("NONTOPHIwest", OR),
              clean_lapply("suTOPHIeast", OR),
              clean_lapply("suTOPHIwest", OR),
              clean_lapply("suNONTOPHIeast", OR),
              clean_lapply("suNONTOPHIwest", OR),
              clean_lapply("FLAREHIGHeast", OR),
              clean_lapply("FLAREHIGHwest", OR),
              clean_lapply("FLARELOWeast", OR),
              clean_lapply("FLARELOWwest", OR),
              clean_lapply("suFLAREHIGHeast", OR),
              clean_lapply("suFLAREHIGHwest", OR),
              clean_lapply("suFLARELOWeast", OR),
              clean_lapply("suFLARELOWwest", OR))

CIString <- c(clean_lapply("TOPHIeast", CI_OR),
              clean_lapply("TOPHIwest", CI_OR),
              clean_lapply("NONTOPHIeast", CI_OR),
              clean_lapply("NONTOPHIwest", CI_OR),
              clean_lapply("suTOPHIeast", CI_OR),
              clean_lapply("suTOPHIwest", CI_OR),
              clean_lapply("suNONTOPHIeast", CI_OR),
              clean_lapply("suNONTOPHIwest", CI_OR),
              clean_lapply("FLAREHIGHeast", CI_OR),
              clean_lapply("FLAREHIGHwest", CI_OR),
              clean_lapply("FLARELOWeast", CI_OR),
              clean_lapply("FLARELOWwest", CI_OR),
              clean_lapply("suFLAREHIGHeast", CI_OR),
              clean_lapply("suFLAREHIGHwest", CI_OR),
              clean_lapply("suFLARELOWeast", CI_OR),
              clean_lapply("suFLARELOWwest", CI_OR))

PvalString <- c(clean_lapply("TOPHIeast", Pval),
                clean_lapply("TOPHIwest", Pval),
                clean_lapply("NONTOPHIeast", Pval),
                clean_lapply("NONTOPHIwest", Pval),
                clean_lapply("suTOPHIeast", Pval),
                clean_lapply("suTOPHIwest", Pval),
                clean_lapply("suNONTOPHIeast", Pval),
                clean_lapply("suNONTOPHIwest", Pval),
                clean_lapply("FLAREHIGHeast", Pval),
                clean_lapply("FLAREHIGHwest", Pval),
                clean_lapply("FLARELOWeast", Pval),
                clean_lapply("FLARELOWwest", Pval),
                clean_lapply("suFLAREHIGHeast", Pval),
                clean_lapply("suFLAREHIGHwest", Pval),
                clean_lapply("suFLARELOWeast", Pval),
                clean_lapply("suFLARELOWwest", Pval))

CollidervsPRS_Poly_noULT <- tibble("Outcome" = OutcomeString,
                             "Predictor" = PredictorString,
                             "Covariates" = CovariateString, 
                             "Cohort" = CohortString, 
                             "OR" = ORString, 
                             "95% CI" = CIString, 
                             "Pval" = PvalString) %>% 
  mutate("Signif." = case_when(Pval < 0.05 / ((x - 2) / 2) ~ "**", 
                               Pval >= 0.05 / ((x - 2) / 2) & Pval < 0.05 ~ "*", 
                               TRUE ~ "-"))
save(CollidervsPRS_Poly_noULT, file = "RData/CollidervsPRS_Poly_noULT.RData")

remove <- ls()
remove <- as_tibble(remove) %>% 
  filter(str_detect(value, "modlist"))
remove <- remove$value
rm(list = remove, remove)
   
remove2 <- ls()
remove2 <- as_tibble(remove2) %>% 
  filter(str_detect(value, "String"))
remove2 <- remove2$value
rm(list = remove2, remove2, grsnames, x, eastpoly_full2, westpoly_full2)
```